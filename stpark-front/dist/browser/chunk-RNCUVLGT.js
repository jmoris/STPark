import{a as l}from"./chunk-VKB6BRO6.js";import{d as p}from"./chunk-DOMNBE5L.js";import{d as u}from"./chunk-7OGW3PNS.js";import{B as d,W as a,_ as i,da as c,ea as b,g as s,l as S,p as h}from"./chunk-BSJZAB7M.js";import{a as o}from"./chunk-TSRGIXR5.js";var v=(()=>{class n{constructor(){this._httpClient=b(u),this._systemConfig=new s({name:"STPark - Sistema de Gesti\xF3n de Estacionamientos",currency:"CLP",timezone:"America/Santiago",language:"es",pos_tuu:!1}),this._configLoaded=!1}loadConfig(){let t={name:"STPark - Sistema de Gesti\xF3n de Estacionamientos",currency:"CLP",timezone:"America/Santiago",language:"es",pos_tuu:!1};return this._httpClient.get(`${l.apiUrl}/settings/general`).pipe(h(e=>{if(e&&e.success&&e.data){let r=o(o({},t),e.data);return(!r.name||r.name.trim()==="")&&(console.warn("ConfigService: El nombre del sistema est\xE1 vac\xEDo, usando valor por defecto"),r.name=t.name),r}return console.warn("ConfigService: La respuesta no tiene el formato esperado:",e),t}),a(e=>{this._systemConfig.next(e),this._configLoaded=!0,console.log("Configuraci\xF3n del sistema cargada:",e)}),d(e=>(console.error("Error al cargar configuraci\xF3n del sistema:",e),this._systemConfig.next(t),S(t))))}refreshConfig(){this.loadConfig().subscribe()}isConfigLoaded(){return this._configLoaded}get systemConfig$(){return this._systemConfig.asObservable()}getSystemConfig(){return this._systemConfig.value}getSystemName(){return this._systemConfig.value.name}getSystemName$(){return this._systemConfig.asObservable().pipe(h(t=>t.name))}getCurrency(){return this._systemConfig.value.currency}getTimezone(){return this._systemConfig.value.timezone}getLanguage(){return this._systemConfig.value.language}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275prov=i({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var E=(()=>{class n{constructor(t,e,r){this.http=t,this.router=e,this.configService=r,this.baseUrl=`${l.authApiUrl}/api/auth`,this.currentUserSubject=new s(null),this.tokenSubject=new s(null),this.tenantsSubject=new s([]),this.currentTenantSubject=new s(null),this.currentUser$=this.currentUserSubject.asObservable(),this.token$=this.tokenSubject.asObservable(),this.tenants$=this.tenantsSubject.asObservable(),this.currentTenant$=this.currentTenantSubject.asObservable(),this.loadStoredAuth()}login(t){return this.http.post(`${this.baseUrl}/login`,t).pipe(a(e=>{console.log("Login response:",e),e.success&&(console.log("Setting auth for user:",e.data.user),console.log("Tenants received:",e.data.tenants),this.setAuth(e.data.user,e.data.token,e.data.tenants),console.log("Auth set successfully. Current tenant:",this.getCurrentTenant()),this.loadSystemConfig())}))}loadSystemConfig(){this.configService.loadConfig().subscribe({next:t=>{console.log("Configuraci\xF3n del sistema cargada exitosamente:",t)},error:t=>{console.error("Error al cargar configuraci\xF3n del sistema:",t)}})}logout(){console.log("Logging out..."),this.clearAuth(),localStorage.removeItem("accessToken"),console.log("Auth data cleared"),this.router.navigate(["/sign-in"])}isAuthenticated(){return!!this.tokenSubject.value}getCurrentUser(){return this.currentUserSubject.value}updateCurrentUser(t){let e=this.currentUserSubject.value;if(e){let r=o(o({},e),t);this.currentUserSubject.next(r),localStorage.setItem("current_user",JSON.stringify(r))}}getToken(){return this.tokenSubject.value}hasRole(t){return this.getCurrentUser()?.role===t}hasAnyRole(t){let e=this.getCurrentUser();return e?t.includes(e.role):!1}getTenants(){return this.tenantsSubject.value}getCurrentTenant(){return this.currentTenantSubject.value}setCurrentTenant(t){this.currentTenantSubject.next(t),t?localStorage.setItem("current_tenant",JSON.stringify(t)):localStorage.removeItem("current_tenant")}setAuth(t,e,r){console.log("setAuth called with:",{user:t,tenants:r}),this.currentUserSubject.next(t),this.tokenSubject.next(e),this.tenantsSubject.next(r),r&&r.length>0&&(console.log("Setting first tenant:",r[0]),this.setCurrentTenant(r[0])),localStorage.setItem("auth_token",e),localStorage.setItem("current_user",JSON.stringify(t)),localStorage.setItem("tenants",JSON.stringify(r)),console.log("Current tenant after setAuth:",this.getCurrentTenant())}clearAuth(){this.currentUserSubject.next(null),this.tokenSubject.next(null),this.tenantsSubject.next([]),this.currentTenantSubject.next(null),localStorage.removeItem("auth_token"),localStorage.removeItem("current_user"),localStorage.removeItem("tenants"),localStorage.removeItem("current_tenant")}loadStoredAuth(){localStorage.getItem("accessToken")&&(console.log("Clearing old accessToken from previous auth system"),localStorage.removeItem("accessToken"));let e=localStorage.getItem("auth_token"),r=localStorage.getItem("current_user"),m=localStorage.getItem("tenants"),f=localStorage.getItem("current_tenant");if(console.log("Loading stored auth data:",{hasToken:!!e,hasUser:!!r}),e&&r)try{let g=JSON.parse(r);if(this.tokenSubject.next(e),this.currentUserSubject.next(g),m){let C=JSON.parse(m);this.tenantsSubject.next(C),f&&this.currentTenantSubject.next(JSON.parse(f))}console.log("Stored auth data loaded successfully")}catch(g){console.error("Error parsing stored user:",g),this.clearAuth()}else console.log("No stored auth data found")}canManageSessions(){return this.hasAnyRole(["admin","operator","supervisor"])}canManagePayments(){return this.hasAnyRole(["admin","cashier","supervisor"])}canManageDebts(){return this.hasAnyRole(["admin","supervisor"])}canManageSectors(){return this.hasAnyRole(["admin","supervisor"])}canManageOperators(){return this.hasAnyRole(["admin","supervisor"])}canViewReports(){return this.hasAnyRole(["admin","supervisor","manager"])}canManageSettings(){return this.hasRole("admin")}static{this.\u0275fac=function(e){return new(e||n)(c(u),c(p),c(v))}}static{this.\u0275prov=i({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{E as a};
