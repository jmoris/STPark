import{a as Ae}from"./chunk-ZWZQJAU5.js";import{o as he,q as Me,u as ve,v as Pe}from"./chunk-IS5LCSW4.js";import{a as Oe}from"./chunk-EP46J676.js";import{a as Ee}from"./chunk-N3PSIUVN.js";import{a as De}from"./chunk-QU4WFXUG.js";import{a as we}from"./chunk-ZMZZWBL4.js";import{f as Fe}from"./chunk-NB6DWIHZ.js";import{a as ye}from"./chunk-VUFBSA72.js";import{a as Se,b as xe}from"./chunk-YOYZ3SXE.js";import{_ as Ce}from"./chunk-GI2EMKD6.js";import{a as fe,b as be}from"./chunk-MVJB4HTB.js";import"./chunk-RRHSJPSV.js";import"./chunk-QT3W5JSU.js";import"./chunk-VKB6BRO6.js";import{b as te,c as ne}from"./chunk-7EGXZGVT.js";import{d as pe,e as ge}from"./chunk-7QQT45KE.js";import{a as ue,b as _e}from"./chunk-7AXTM6W3.js";import{b as R,c as Z,d as Y,e as J,j as K,k as Q}from"./chunk-DO3SX6N4.js";import{b as ie,d as P,f as oe,g as re,k as ae,n as se,o as le,u as ce,v as de,y as me}from"./chunk-EGGCURRC.js";import{fa as H,la as X,oa as ee}from"./chunk-AHUY5V3P.js";import"./chunk-2JMYS33K.js";import"./chunk-CQGOYTFO.js";import{d as G}from"./chunk-DOMNBE5L.js";import"./chunk-7OGW3PNS.js";import{l as A,m as $,s as I}from"./chunk-TQARHOKX.js";import{$b as b,Eb as c,Gb as N,Hb as L,Ib as W,Pb as n,Qb as i,Rb as M,U as f,Vb as q,bb as s,bc as p,cb as h,f as j,mc as r,nc as _,oa as S,oc as C,pa as x,pb as E,pc as T,qc as U,rc as F,sc as w,tc as D,vc as B,wb as g,ya as y}from"./chunk-BSJZAB7M.js";import"./chunk-TSRGIXR5.js";var Be=()=>({width:"50rem"}),Ve=()=>({"1199px":"70vw","575px":"90vw"});function ze(a,m){if(a&1&&(n(0,"div",26)(1,"div",27)(2,"div",28)(3,"div",29),M(4,"i",30),n(5,"span"),r(6),i()(),n(7,"div",31),r(8),i()(),n(9,"div",32)(10,"span",33),r(11),i(),n(12,"span",34),r(13),i()()()()),a&2){let e=m.$implicit,o=p();s(4),W(o.getOriginIcon(e.origin)),s(2),_(o.getOriginText(e.origin)),s(2),_(o.formatAmount(e.principal_amount)),s(3),C("ID: ",e.id,""),s(2),_(o.getDebtAge(e))}}function je(a,m){if(a&1){let e=q();n(0,"div",35)(1,"button",36),b("click",function(){S(e);let t=p();return x(t.closeModal())}),i(),n(2,"div",37)(3,"button",38),b("click",function(){S(e);let t=p();return x(t.onContinueWithoutPayment())}),i(),n(4,"button",39),b("click",function(){S(e);let t=p();return x(t.onPayDebts())}),i()()()}}var Ie=(()=>{class a{constructor(){this.visible=!1,this.debts=[],this.plate="",this.visibleChange=new y,this.payDebts=new y,this.continueWithoutPayment=new y}closeModal(){this.visible=!1,this.visibleChange.emit(!1)}onPayDebts(){this.payDebts.emit(),this.closeModal()}onContinueWithoutPayment(){this.continueWithoutPayment.emit(),this.closeModal()}formatAmount(e){return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0,maximumFractionDigits:0}).format(e).replace("CLP","$")}getTotalDebtAmount(){return this.debts.reduce((e,o)=>e+o.principal_amount,0)}getOriginText(e){switch(e){case"SESSION":return"Sesi\xF3n de Estacionamiento";case"FINE":return"Multa";case"MANUAL":return"Manual";default:return e}}getOriginIcon(e){switch(e){case"SESSION":return"pi-car";case"FINE":return"pi-exclamation-triangle";case"MANUAL":return"pi-user-edit";default:return"pi-question-circle"}}getDebtAge(e){let o=new Date(e.created_at),d=Math.abs(new Date().getTime()-o.getTime()),l=Math.ceil(d/(1e3*60*60*24));if(l===0)return"Hoy";if(l===1)return"Ayer";if(l<7)return`${l} d\xEDas`;if(l<30){let u=Math.floor(l/7);return`${u} semana${u>1?"s":""}`}let v=Math.floor(l/30);return`${v} mes${v>1?"es":""}`}static{this.\u0275fac=function(o){return new(o||a)}}static{this.\u0275cmp=E({type:a,selectors:[["app-debt-alert-modal"]],inputs:{visible:"visible",debts:"debts",plate:"plate"},outputs:{visibleChange:"visibleChange",payDebts:"payDebts",continueWithoutPayment:"continueWithoutPayment"},decls:49,vars:18,consts:[["header","\u26A0\uFE0F DEUDAS PENDIENTES DETECTADAS",3,"visibleChange","visible","modal","breakpoints","draggable","resizable","closable","closeOnEscape"],[1,"debt-alert-content"],[1,"alert-header"],[1,"plate-info"],[1,"pi","pi-car","plate-icon"],[1,"plate-text"],[1,"alert-message"],[1,"alert-title"],[1,"alert-subtitle"],[1,"debts-list"],[1,"debt-items"],["class","debt-item",4,"ngFor","ngForOf"],[1,"recommendation"],[1,"recommendation-content"],[1,"pi","pi-info-circle","recommendation-icon"],[1,"recommendation-text"],[1,"action-options"],[1,"option-card","pay-option"],[1,"option-header"],[1,"pi","pi-credit-card","option-icon"],[1,"option-description"],[1,"option-total"],[1,"option-card","continue-option"],[1,"pi","pi-play","option-icon"],[1,"option-warning"],["pTemplate","footer"],[1,"debt-item"],[1,"debt-info"],[1,"debt-header"],[1,"debt-origin"],[1,"origin-icon"],[1,"debt-amount"],[1,"debt-details"],[1,"debt-id"],[1,"debt-age"],[1,"flex","justify-between","w-full"],["pButton","","type","button","label","Cancelar","icon","pi pi-times",1,"p-button-text",3,"click"],[1,"flex","gap-2"],["pButton","","type","button","label","Continuar Sin Pagar","icon","pi pi-play",1,"p-button-outlined","p-button-warning",3,"click"],["pButton","","type","button","label","Liquidar Deudas","icon","pi pi-credit-card",1,"p-button-success",3,"click"]],template:function(o,t){o&1&&(n(0,"p-dialog",0),D("visibleChange",function(l){return w(t.visible,l)||(t.visible=l),l}),b("visibleChange",function(l){return t.visibleChange.emit(l)}),n(1,"div",1)(2,"div",2)(3,"div",3),M(4,"i",4),n(5,"span",5),r(6),i()(),n(7,"div",6)(8,"p",7),r(9,"Esta patente tiene deudas pendientes"),i(),n(10,"p",8),r(11),n(12,"strong"),r(13),i()()()(),n(14,"div",9)(15,"h4"),r(16,"Deudas Pendientes:"),i(),n(17,"div",10),g(18,ze,14,6,"div",11),i()(),n(19,"div",12)(20,"div",13),M(21,"i",14),n(22,"div",15)(23,"p")(24,"strong"),r(25,"Recomendaci\xF3n:"),i(),r(26," Te sugerimos liquidar las deudas pendientes antes de iniciar una nueva sesi\xF3n para evitar acumulaci\xF3n de intereses."),i()()()(),n(27,"div",16)(28,"div",17)(29,"div",18),M(30,"i",19),n(31,"h5"),r(32,"Liquidar Deudas"),i()(),n(33,"p",20),r(34,"Pagar todas las deudas pendientes antes de iniciar la nueva sesi\xF3n."),i(),n(35,"div",21),r(36," Total a pagar: "),n(37,"strong"),r(38),i()()(),n(39,"div",22)(40,"div",18),M(41,"i",23),n(42,"h5"),r(43,"Continuar Sin Pagar"),i()(),n(44,"p",20),r(45,"Iniciar la nueva sesi\xF3n sin liquidar las deudas pendientes."),i(),n(46,"div",24),r(47," \u26A0\uFE0F Las deudas seguir\xE1n pendientes "),i()()()(),g(48,je,5,0,"ng-template",25),i()),o&2&&(L(B(16,Be)),F("visible",t.visible),c("modal",!0)("breakpoints",B(17,Ve))("draggable",!1)("resizable",!1)("closable",!1)("closeOnEscape",!1),s(6),_(t.plate),s(5),U("Se encontraron ",t.debts.length," deuda",t.debts.length>1?"s":""," pendiente",t.debts.length>1?"s":""," por un total de "),s(2),_(t.formatAmount(t.getTotalDebtAmount())),s(5),c("ngForOf",t.debts),s(20),_(t.formatAmount(t.getTotalDebtAmount())))},dependencies:[I,A,Pe,ve,Ce,Me,he],styles:[".debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding:1rem;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:.75rem;border-left:4px solid #f59e0b}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;background:#fffc;padding:.75rem 1rem;border-radius:.5rem;box-shadow:0 2px 4px #0000001a}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]   .plate-icon[_ngcontent-%COMP%]{font-size:1.5rem;color:#1e40af}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]   .plate-text[_ngcontent-%COMP%]{font-family:Monaco,Menlo,Ubuntu Mono,monospace;font-size:1.25rem;font-weight:700;color:#1e40af;text-transform:uppercase;letter-spacing:.1em}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .alert-message[_ngcontent-%COMP%]{flex:1}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .alert-message[_ngcontent-%COMP%]   .alert-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;color:#92400e;margin:0 0 .25rem}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .alert-message[_ngcontent-%COMP%]   .alert-subtitle[_ngcontent-%COMP%]{font-size:.95rem;color:#a16207;margin:0}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]{margin-bottom:1.5rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:#374151;margin-bottom:.75rem;padding-bottom:.25rem;border-bottom:1px solid #e5e7eb}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-items[_ngcontent-%COMP%]{max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:.5rem;background:#f9fafb}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]{padding:.75rem;border-bottom:1px solid #e5e7eb;background:#fff;transition:background-color .2s ease}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]:hover{background:#f3f4f6}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]   .debt-origin[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;font-size:.9rem;color:#6b7280}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]   .debt-origin[_ngcontent-%COMP%]   .origin-icon[_ngcontent-%COMP%]{font-size:1rem;color:#9ca3af}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]   .debt-amount[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700;color:#dc2626}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-size:.8rem;color:#9ca3af}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]   .debt-id[_ngcontent-%COMP%]{font-family:Monaco,Menlo,Ubuntu Mono,monospace;background:#f3f4f6;padding:.125rem .375rem;border-radius:.25rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]   .debt-age[_ngcontent-%COMP%]{font-style:italic}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]{margin-bottom:1.5rem;padding:1rem;background:#eff6ff;border-radius:.5rem;border-left:4px solid #3b82f6}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:.75rem}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]   .recommendation-icon[_ngcontent-%COMP%]{font-size:1.25rem;color:#3b82f6;margin-top:.125rem}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]   .recommendation-text[_ngcontent-%COMP%]{flex:1}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]   .recommendation-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:.9rem;color:#1e40af;line-height:1.5}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]{padding:1rem;border-radius:.75rem;border:2px solid transparent;transition:all .2s ease;cursor:pointer}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #0000001a}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.pay-option[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:#22c55e}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.pay-option[_ngcontent-%COMP%]:hover{border-color:#16a34a;background:linear-gradient(135deg,#ecfdf5,#d1fae5)}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.continue-option[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fefce8,#fef3c7);border-color:#eab308}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.continue-option[_ngcontent-%COMP%]:hover{border-color:#ca8a04;background:linear-gradient(135deg,#fef9c3,#fde68a)}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-header[_ngcontent-%COMP%]   .option-icon[_ngcontent-%COMP%]{font-size:1.25rem}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-header[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-description[_ngcontent-%COMP%]{font-size:.9rem;color:#6b7280;margin-bottom:.75rem;line-height:1.4}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-total[_ngcontent-%COMP%]{font-size:.9rem;color:#059669;font-weight:600}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-warning[_ngcontent-%COMP%]{font-size:.9rem;color:#d97706;font-weight:600}@media (max-width: 768px){.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch;gap:.75rem}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]{justify-content:center}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]{grid-template-columns:1fr}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.5rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]{flex-direction:column;gap:.25rem}}[_nghost-%COMP%]     .p-dialog-footer{padding:1rem 1.5rem;border-top:1px solid #e5e7eb;background-color:#f9fafb}"]})}}return a})();function Le(a,m){if(a&1&&(n(0,"mat-error"),r(1),i()),a&2){let e=p();s(),C(" ",e.getFieldError("plate")," ")}}function We(a,m){if(a&1&&(n(0,"mat-option",29),r(1),i()),a&2){let e=m.$implicit;c("value",e.id),s(),T(" ",e.name," ",e.is_private?"(Privado)":"(P\xFAblico)"," ")}}function qe(a,m){if(a&1&&(n(0,"mat-error"),r(1),i()),a&2){let e=p();s(),C(" ",e.getFieldError("sector_id")," ")}}function Ue(a,m){if(a&1&&(n(0,"mat-option",29),r(1),i()),a&2){let e=m.$implicit;c("value",e.id),s(),C(" ",e.name," ")}}function $e(a,m){if(a&1&&(n(0,"mat-error"),r(1),i()),a&2){let e=p();s(),C(" ",e.getFieldError("street_id")," ")}}function Ge(a,m){a&1&&(n(0,"mat-hint"),r(1,"Selecciona primero un sector"),i())}function He(a,m){a&1&&(n(0,"mat-hint"),r(1,"Este sector no tiene calles registradas"),i())}function Re(a,m){if(a&1&&(n(0,"mat-option",29),r(1),i()),a&2){let e=m.$implicit;c("value",e.id),s(),T(" ",e.name," - ",e.rut," ")}}function Ze(a,m){if(a&1&&(n(0,"mat-error"),r(1),i()),a&2){let e=p();s(),C(" ",e.getFieldError("operator_id")," ")}}function Ye(a,m){a&1&&(n(0,"mat-hint"),r(1,"Selecciona primero un sector y una calle"),i())}function Je(a,m){a&1&&(n(0,"mat-hint"),r(1,"No hay operadores disponibles para este sector y calle"),i())}function Ke(a,m){if(a&1&&(n(0,"div",33)(1,"mat-icon",34),r(2,"directions_car"),i(),n(3,"div")(4,"p",35),r(5,"Placa"),i(),n(6,"p",36),r(7),i()()()),a&2){let e=p(2);s(7),_(e.sessionForm.value.plate)}}function Qe(a,m){if(a&1&&(n(0,"div",33)(1,"mat-icon",34),r(2,"location_on"),i(),n(3,"div")(4,"p",35),r(5,"Sector"),i(),n(6,"p",36),r(7),i()()()),a&2){let e=p(2);s(7),_(e.getSectorName(e.sessionForm.value.sector_id))}}function Xe(a,m){if(a&1&&(n(0,"div",33)(1,"mat-icon",34),r(2,"place"),i(),n(3,"div")(4,"p",35),r(5,"Calle"),i(),n(6,"p",36),r(7),i()()()),a&2){let e=p(2);s(7),_(e.getStreetName(e.sessionForm.value.street_id))}}function et(a,m){if(a&1&&(n(0,"div",33)(1,"mat-icon",34),r(2,"person"),i(),n(3,"div")(4,"p",35),r(5,"Operador"),i(),n(6,"p",36),r(7),i()()()),a&2){let e=p(2);s(7),_(e.getOperatorName(e.sessionForm.value.operator_id))}}function tt(a,m){if(a&1&&(n(0,"fuse-card",30)(1,"div",25)(2,"h3",26),r(3,"Informaci\xF3n de la Sesi\xF3n"),i(),n(4,"div",31),g(5,Ke,8,1,"div",32)(6,Qe,8,1,"div",32)(7,Xe,8,1,"div",32)(8,et,8,1,"div",32),i()()()),a&2){let e=p();s(5),c("ngIf",e.sessionForm.value.plate),s(),c("ngIf",e.sessionForm.value.sector_id),s(),c("ngIf",e.sessionForm.value.street_id),s(),c("ngIf",e.sessionForm.value.operator_id)}}function nt(a,m){if(a&1&&(n(0,"div",37)(1,"fuse-alert",38),r(2),i()()),a&2){let e=p();s(),c("dismissible",!0),s(),C(" ",e.error," ")}}function it(a,m){a&1&&M(0,"mat-spinner",39)}function ot(a,m){a&1&&(n(0,"mat-icon"),r(1,"add"),i())}var $t=(()=>{class a{constructor(e,o,t,d,l,v,u,O){this.fb=e,this.sessionService=o,this.sectorService=t,this.operatorService=d,this.debtService=l,this.printerService=v,this.router=u,this.snackBar=O,this._unsubscribeAll=new j,this.loading=!1,this.error=null,this.sectors=[],this.operators=[],this.streets=[],this.operatorAssignments=[],this.currentOperator=null,this.showDebtAlert=!1,this.pendingDebts=[],this.currentPlate="",this.sessionForm=this.createForm()}ngOnInit(){this.loadSectors(),this.loadOperators(),this.setupFormSubscriptions()}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}createForm(){return this.fb.group({plate:["",[P.required,P.pattern(/^[A-Z0-9]+$/i)]],sector_id:["",P.required],street_id:[null,P.required],operator_id:["",P.required]})}setupFormSubscriptions(){this.sessionForm.get("sector_id")?.valueChanges.pipe(f(this._unsubscribeAll)).subscribe(e=>{e?(this.sessionForm.patchValue({street_id:null,operator_id:""}),this.loadStreetsBySector(e)):(this.streets=[],this.operators=[],this.sessionForm.patchValue({street_id:null,operator_id:""}))}),this.sessionForm.get("street_id")?.valueChanges.pipe(f(this._unsubscribeAll)).subscribe(e=>{let o=this.sessionForm.value.sector_id;o&&e?this.filterOperatorsBySectorAndStreet(o,e):e||(this.operators=[]),this.sessionForm.patchValue({operator_id:""},{emitEvent:!1})})}loadSectors(){this.sectorService.getSectors().pipe(f(this._unsubscribeAll)).subscribe({next:e=>{this.sectors=e.data?.data||[]},error:e=>{console.error("Error loading sectors:",e),this.snackBar.open("Error al cargar sectores","Cerrar",{duration:3e3})}})}loadOperators(){this.operatorService.getOperators().pipe(f(this._unsubscribeAll)).subscribe({next:e=>{this.operators=e.data?.data||[]},error:e=>{console.error("Error loading operators:",e),this.snackBar.open("Error al cargar operadores","Cerrar",{duration:3e3})}})}loadStreetsBySector(e){if(!e){this.streets=[],console.log("No sector selected, clearing streets");return}console.log("Loading streets for sector:",e),this.sectorService.getSectorStreets(e).pipe(f(this._unsubscribeAll)).subscribe({next:o=>{this.streets=o.data||[],console.log("Streets loaded for sector",e,":",this.streets.length,"streets"),this.streets.length>0?(this.sessionForm.patchValue({street_id:this.streets[0].id}),console.log("Auto-selected first street:",this.streets[0].id)):this.sessionForm.patchValue({street_id:null})},error:o=>{console.error("Error loading streets:",o),this.streets=[],this.sessionForm.patchValue({street_id:null})}})}filterOperatorsBySector(e){if(!e){this.operators=[];return}this.operatorService.getOperators().pipe(f(this._unsubscribeAll)).subscribe({next:o=>{this.operators=(o.data?.data||[]).filter(t=>t.sectors?.some(d=>d.id===e&&this.isAssignmentValid(d.pivot)))},error:o=>{console.error("Error filtering operators:",o),this.operators=[]}})}filterOperatorsBySectorAndStreet(e,o){if(!e){this.operators=[];return}console.log("Filtrando operadores para sector:",e,"calle:",o),this.operatorService.getOperators().pipe(f(this._unsubscribeAll)).subscribe({next:t=>{let d=t.data?.data||[];console.log("Todos los operadores cargados:",d.length),this.operators=d.filter(l=>{let v=l.operator_assignments?.some(u=>{if(u.sector_id===e){let O=new Date,ke=new Date(u.valid_from),V=u.valid_to?new Date(u.valid_to):null,z=ke<=O&&(!V||V>=O),k=!0;return o&&(k=!u.street_id||u.street_id===o),console.log("Operador:",l.name,"Sector match:",u.sector_id===e,"Street access:",k,"Date valid:",z,"Assignment:",u),z&&k}return!1});return console.log("Operador:",l.name,"Has valid assignment:",v),v}),console.log("Operadores filtrados:",this.operators.length)},error:t=>{console.error("Error filtering operators:",t),this.operators=[]}})}isAssignmentValid(e){let o=new Date,t=new Date(e.valid_from),d=e.valid_to?new Date(e.valid_to):null;return t<=o&&(!d||d>=o)}onSubmit(){if(this.sessionForm.invalid){this.markFormGroupTouched();return}let e=this.sessionForm.value.plate.toUpperCase();if(!this.sessionService.validateChileanPlate(e)){this.snackBar.open("Formato de patente inv\xE1lido","Cerrar",{duration:3e3});return}this.checkPendingDebts(e)}checkPendingDebts(e){this.loading=!0,this.error=null,this.debtService.getDebtsByPlate(e).pipe(f(this._unsubscribeAll)).subscribe({next:o=>{let d=(o.data||[]).filter(l=>l.status==="PENDING");d.length>0?(this.pendingDebts=d,this.currentPlate=e,this.showDebtAlert=!0,this.loading=!1):this.createSession(e)},error:o=>{console.error("Error checking debts:",o),this.createSession(e)}})}createSession(e){this.loading=!0,this.error=null;let o=this.sessionForm.value.street_id,t=o&&o!==""?o:null,d={plate:e,sector_id:this.sessionForm.value.sector_id,street_id:t,operator_id:this.sessionForm.value.operator_id};this.sessionService.createSession(d).pipe(f(this._unsubscribeAll)).subscribe({next:l=>{this.snackBar.open("Sesi\xF3n creada exitosamente","Cerrar",{duration:3e3}),this.printEntryTicket(l.data),this.router.navigate(["/parking/sessions",l.data.id])},error:l=>{this.error=l.error?.message||"Error al crear sesi\xF3n",this.loading=!1,console.error("Error creating session:",l),l.error?.error_code==="NO_SHIFT_OPEN"?(this.snackBar.open("No hay turno abierto para este operador. Abre un turno antes de crear sesiones.","Cerrar",{duration:7e3}),this.router.navigate(["/parking/shifts"])):this.snackBar.open(this.error,"Cerrar",{duration:5e3})}})}onPayDebts(){this.router.navigate(["/parking/debts"],{queryParams:{plate:this.currentPlate,filter:"PENDING"}})}onContinueWithoutPayment(){this.createSession(this.currentPlate)}closeDebtAlert(){this.showDebtAlert=!1,this.pendingDebts=[],this.currentPlate="",this.loading=!1}markFormGroupTouched(){Object.keys(this.sessionForm.controls).forEach(e=>{this.sessionForm.get(e)?.markAsTouched()})}onCancel(){this.router.navigate(["/parking/sessions"])}getFieldError(e){let o=this.sessionForm.get(e);if(o?.errors&&o.touched){if(o.errors.required)return`${this.getFieldLabel(e)} es requerido`;if(o.errors.pattern)return`${this.getFieldLabel(e)} tiene un formato inv\xE1lido`}return""}getFieldLabel(e){return{plate:"Placa",sector_id:"Sector",street_id:"Calle",operator_id:"Operador"}[e]||e}isFieldInvalid(e){let o=this.sessionForm.get(e);return!!(o?.invalid&&o.touched)}formatPlate(e){let t=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"");this.sessionForm.patchValue({plate:t})}getSectorName(e){let o=this.sectors.find(t=>t.id===e);return o?o.name:""}getStreetName(e){let o=this.streets.find(t=>t.id===e);return o?o.name:""}getOperatorName(e){let o=this.operators.find(t=>t.id===e);return o?o.name:""}hasStreets(){return this.streets.length>0}hasOperators(){return this.operators.length>0}printEntryTicket(e){this.printerService.printEntryTicket(e).pipe(f(this._unsubscribeAll)).subscribe({next:o=>{o.printed?this.snackBar.open("Ticket de entrada impreso exitosamente","Cerrar",{duration:3e3}):this.snackBar.open(o.message,"Cerrar",{duration:5e3})},error:o=>{console.error("Error printing entry ticket:",o),this.snackBar.open("Error al imprimir ticket de entrada","Cerrar",{duration:3e3})}})}static{this.\u0275fac=function(o){return new(o||a)(h(de),h(ye),h(we),h(De),h(Ee),h(Ae),h(G),h(fe))}}static{this.\u0275cmp=E({type:a,selectors:[["app-new-session"]],decls:76,vars:28,consts:[[1,"p-6","mx-auto"],[1,"mb-8"],[1,"flex","items-center","justify-between"],[1,"text-3xl","font-bold","text-gray-900"],[1,"mt-2","text-gray-600"],["mat-button","",1,"rounded-sm",3,"click"],[1,"max-w-2xl","mx-auto"],[1,"p-6"],["novalidate","",3,"ngSubmit","formGroup"],["appearance","outline",1,"w-full","mb-4"],["matInput","","formControlName","plate","placeholder","ABC123","maxlength","10","autocomplete","off",3,"input"],["matPrefix",""],[4,"ngIf"],["formControlName","sector_id"],[3,"value",4,"ngFor","ngForOf"],["formControlName","street_id",3,"disabled"],["appearance","outline",1,"w-full","mb-6"],["formControlName","operator_id",3,"disabled"],["class","mb-6",4,"ngIf"],["class","mb-4",4,"ngIf"],[1,"flex","items-center","justify-end","gap-4"],["type","button","mat-button","",3,"click","disabled"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],[1,"mt-6"],[1,"p-4"],[1,"text-lg","font-medium","text-gray-900","mb-3"],[1,"space-y-2","text-sm","text-gray-600"],[3,"visibleChange","payDebts","continueWithoutPayment","visible","debts","plate"],[3,"value"],[1,"mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],["class","flex items-center",4,"ngIf"],[1,"flex","items-center"],[1,"text-gray-500","mr-2"],[1,"text-sm","text-gray-600"],[1,"font-medium","text-gray-900"],[1,"mb-4"],["type","error",3,"dismissible"],["diameter","20",1,"mr-2"]],template:function(o,t){o&1&&(n(0,"div",0)(1,"div",1)(2,"div",2)(3,"div")(4,"h1",3),r(5,"Nueva Sesi\xF3n de Estacionamiento"),i(),n(6,"p",4),r(7,"Crear una nueva sesi\xF3n de estacionamiento"),i()(),n(8,"button",5),b("click",function(){return t.onCancel()}),n(9,"mat-icon"),r(10,"arrow_back"),i(),r(11," Volver a Sesiones "),i()()(),n(12,"div",6)(13,"fuse-card")(14,"div",7)(15,"form",8),b("ngSubmit",function(){return t.onSubmit()}),n(16,"mat-form-field",9)(17,"mat-label"),r(18,"Placa del Veh\xEDculo"),i(),n(19,"input",10),b("input",function(l){return t.formatPlate(l)}),i(),n(20,"mat-icon",11),r(21,"directions_car"),i(),n(22,"mat-hint"),r(23,"Formato: ABC123, 1234AB, ABCD12"),i(),g(24,Le,2,1,"mat-error",12),i(),n(25,"mat-form-field",9)(26,"mat-label"),r(27,"Sector"),i(),n(28,"mat-select",13),g(29,We,2,3,"mat-option",14),i(),n(30,"mat-icon",11),r(31,"location_on"),i(),g(32,qe,2,1,"mat-error",12),i(),n(33,"mat-form-field",9)(34,"mat-label"),r(35,"Calle *"),i(),n(36,"mat-select",15),g(37,Ue,2,2,"mat-option",14),i(),n(38,"mat-icon",11),r(39,"place"),i(),g(40,$e,2,1,"mat-error",12)(41,Ge,2,0,"mat-hint",12)(42,He,2,0,"mat-hint",12),i(),n(43,"mat-form-field",16)(44,"mat-label"),r(45,"Operador"),i(),n(46,"mat-select",17),g(47,Re,2,3,"mat-option",14),i(),n(48,"mat-icon",11),r(49,"person"),i(),g(50,Ze,2,1,"mat-error",12)(51,Ye,2,0,"mat-hint",12)(52,Je,2,0,"mat-hint",12),i(),g(53,tt,9,4,"fuse-card",18)(54,nt,3,2,"div",19),n(55,"div",20)(56,"button",21),b("click",function(){return t.onCancel()}),r(57," Cancelar "),i(),n(58,"button",22),g(59,it,1,0,"mat-spinner",23)(60,ot,2,0,"mat-icon",12),r(61),i()()()()(),n(62,"fuse-card",24)(63,"div",25)(64,"h3",26),r(65,"Informaci\xF3n Importante"),i(),n(66,"div",27)(67,"p"),r(68,"\u2022 La placa debe tener un formato v\xE1lido chileno (ABC123, 1234AB, ABCD12)"),i(),n(69,"p"),r(70,"\u2022 Solo se pueden crear sesiones en sectores donde el operador tenga acceso"),i(),n(71,"p"),r(72,"\u2022 Una vez creada la sesi\xF3n, el veh\xEDculo estar\xE1 registrado como estacionado"),i(),n(73,"p"),r(74,"\u2022 El sistema validar\xE1 autom\xE1ticamente que no exista otra sesi\xF3n activa para la misma placa en el sector"),i()()()()(),n(75,"app-debt-alert-modal",28),D("visibleChange",function(l){return w(t.showDebtAlert,l)||(t.showDebtAlert=l),l}),b("payDebts",function(){return t.onPayDebts()})("continueWithoutPayment",function(){return t.onContinueWithoutPayment()})("visibleChange",function(){return t.closeDebtAlert()}),i()()),o&2&&(s(15),c("formGroup",t.sessionForm),s(9),c("ngIf",t.isFieldInvalid("plate")),s(5),c("ngForOf",t.sectors),s(3),c("ngIf",t.isFieldInvalid("sector_id")),s(),N("mat-form-field-disabled",!t.hasStreets()),s(3),c("disabled",!t.sessionForm.value.sector_id),s(),c("ngForOf",t.streets),s(3),c("ngIf",t.isFieldInvalid("street_id")),s(),c("ngIf",!t.sessionForm.value.sector_id),s(),c("ngIf",t.sessionForm.value.sector_id&&!t.hasStreets()),s(),N("mat-form-field-disabled",!t.hasOperators()),s(3),c("disabled",!t.hasOperators()||!t.sessionForm.value.sector_id||!t.sessionForm.value.street_id),s(),c("ngForOf",t.operators),s(3),c("ngIf",t.isFieldInvalid("operator_id")),s(),c("ngIf",!t.sessionForm.value.sector_id),s(),c("ngIf",t.sessionForm.value.sector_id&&t.sessionForm.value.street_id&&!t.hasOperators()),s(),c("ngIf",t.sessionForm.value.sector_id||t.sessionForm.value.operator_id),s(),c("ngIf",t.error),s(2),c("disabled",t.loading),s(2),c("disabled",t.loading||t.sessionForm.invalid||!t.hasOperators()),s(),c("ngIf",t.loading),s(),c("ngIf",!t.loading),s(),C(" ",t.loading?"Creando...":"Crear Sesi\xF3n"," "),s(14),F("visible",t.showDebtAlert),c("debts",t.pendingDebts)("plate",t.currentPlate))},dependencies:[I,A,$,me,ae,ie,oe,re,ce,se,le,ee,X,ne,te,Q,K,R,Y,Z,J,ge,pe,xe,Se,H,Fe,_e,ue,be,Oe,Ie],styles:[".form-container[_ngcontent-%COMP%]{max-width:600px;margin:0 auto}.info-card[_ngcontent-%COMP%]{background-color:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]{display:flex;align-items:center;padding:.5rem 0}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#6b7280;margin-right:.75rem}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]   .info-label[_ngcontent-%COMP%]{font-size:.875rem;color:#6b7280;margin-bottom:.25rem}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]   .info-value[_ngcontent-%COMP%]{font-weight:500;color:#111827}.help-card[_ngcontent-%COMP%]{background-color:#f0f9ff;border:1px solid #bae6fd;border-radius:8px}.help-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#0c4a6e}.help-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#075985}.mat-form-field[_ngcontent-%COMP%]{width:100%}.action-buttons[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:1rem;margin-top:2rem}.loading-button[_ngcontent-%COMP%]{display:flex;align-items:center}.loading-button[_ngcontent-%COMP%]   mat-spinner[_ngcontent-%COMP%]{margin-right:.5rem}@media (max-width: 768px){.form-container[_ngcontent-%COMP%]{max-width:100%;padding:0 1rem}.action-buttons[_ngcontent-%COMP%]{flex-direction:column-reverse}.action-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}.error-alert[_ngcontent-%COMP%]{margin-bottom:1rem}.success-message[_ngcontent-%COMP%]{background-color:#f0fdf4;border:1px solid #bbf7d0;color:#166534;padding:1rem;border-radius:8px;margin-bottom:1rem}"]})}}return a})();export{$t as NewSessionComponent};
