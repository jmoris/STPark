import{a as ee}from"./chunk-ZWZQJAU5.js";import{a as te}from"./chunk-TEBOILAG.js";import{a as J}from"./chunk-EP46J676.js";import{c as Y}from"./chunk-5BS7ZJIQ.js";import{f as Z}from"./chunk-NB6DWIHZ.js";import{a as X}from"./chunk-RO7KOFOP.js";import{b as K}from"./chunk-YOYZ3SXE.js";import{b as z}from"./chunk-BFKOMUGM.js";import"./chunk-2LVKS4R7.js";import{a as U,b as G}from"./chunk-MVJB4HTB.js";import{g as $}from"./chunk-EX2CTHYK.js";import{c as D,h as B}from"./chunk-7DEXAUWQ.js";import"./chunk-RRHSJPSV.js";import"./chunk-QT3W5JSU.js";import"./chunk-VKB6BRO6.js";import{b as j,c as L}from"./chunk-7EGXZGVT.js";import{e as R}from"./chunk-7QQT45KE.js";import{a as Q,b as W}from"./chunk-7AXTM6W3.js";import{k as N}from"./chunk-DO3SX6N4.js";import{d as C,v as H,y as O}from"./chunk-EGGCURRC.js";import{la as P,oa as V}from"./chunk-AHUY5V3P.js";import"./chunk-2JMYS33K.js";import"./chunk-CQGOYTFO.js";import{b as q,d as T}from"./chunk-DOMNBE5L.js";import"./chunk-7OGW3PNS.js";import{l as I,m as F,s as w}from"./chunk-TQARHOKX.js";import{$b as b,Eb as m,Fb as M,Ib as _,Pb as o,Qb as n,Rb as k,U as g,Vb as v,bb as s,bc as l,cb as d,f as y,mc as r,nc as u,oa as f,oc as S,pa as x,pb as E,pc as A,wb as p}from"./chunk-BSJZAB7M.js";import"./chunk-TSRGIXR5.js";function ae(a,c){if(a&1){let e=v();o(0,"button",7),b("click",function(){f(e);let i=l();return x(i.openPaymentModal())}),o(1,"mat-icon"),r(2,"payment"),n(),r(3," Finalizar Sesi\xF3n "),n()}}function se(a,c){a&1&&(o(0,"div",8),k(1,"mat-spinner",9),o(2,"p",10),r(3,"Cargando sesi\xF3n..."),n()())}function ue(a,c){if(a&1){let e=v();o(0,"div",8)(1,"mat-icon",11),r(2,"error"),n(),o(3,"h2",12),r(4,"Error"),n(),o(5,"p",13),r(6),n(),o(7,"button",7),b("click",function(){f(e);let i=l();return x(i.onBack())}),o(8,"mat-icon"),r(9,"arrow_back"),n(),r(10," Volver "),n()()}if(a&2){let e=l();s(6),u(e.error)}}function me(a,c){if(a&1&&(o(0,"div")(1,"label",19),r(2,"Fin"),n(),o(3,"p",20),r(4),n()()),a&2){let e=l(2);s(4),u(e.formatDateTime(e.session.ended_at))}}function le(a,c){a&1&&(o(0,"fuse-card")(1,"div",25),k(2,"mat-spinner",26),o(3,"p",3),r(4,"Calculando cotizaci\xF3n..."),n()()())}function ce(a,c){if(a&1&&(o(0,"div",28)(1,"label",19),r(2,"M\xE1ximo diario"),n(),o(3,"p",35),r(4),n()()),a&2){let e=l(3);s(4),u(e.getDailyMaxAmount())}}function de(a,c){if(a&1&&(o(0,"div",42)(1,"span",3),r(2),n(),o(3,"span",43),r(4),n()()),a&2){let e=c.$implicit,t=l(5);_(e.is_daily_max_adjustment?"border-orange-300 bg-orange-50":""),s(),_(e.is_daily_max_adjustment?"text-orange-800 font-semibold":""),s(),A(" ",e.rule_name," (",e.minutes," min) "),s(),_(e.is_daily_max_adjustment?"text-orange-700":""),s(),S(" ",t.formatAmount(e.amount)," ")}}function pe(a,c){if(a&1&&(o(0,"div",40),p(1,de,5,9,"div",41),n()),a&2){let e=l(4);s(),m("ngForOf",e.quote.breakdown)}}function he(a,c){if(a&1){let e=v();o(0,"div",36)(1,"button",37),b("click",function(){f(e);let i=l(3);return x(i.toggleBreakdown())}),o(2,"span"),r(3,"Desglose por reglas:"),n(),o(4,"mat-icon",38),r(5," expand_more "),n()(),p(6,pe,2,1,"div",39),n()}if(a&2){let e=l(3);s(4),M("transform",e.breakdownExpanded?"rotate(180deg)":"rotate(0deg)"),s(2),m("ngIf",e.breakdownExpanded)}}function ge(a,c){if(a&1&&(o(0,"fuse-card")(1,"div",16)(2,"h2",17),r(3,"Desglose de Costos"),n(),o(4,"div",27)(5,"div",28)(6,"label",19),r(7,"Tarifa por minuto"),n(),o(8,"p",29),r(9),n()(),p(10,ce,5,1,"div",30),n(),o(11,"div",27)(12,"div",28)(13,"label",19),r(14,"Duraci\xF3n"),n(),o(15,"p",29),r(16),n()(),o(17,"div",31)(18,"label",32),r(19,"Total a Pagar"),n(),o(20,"p",33),r(21),n()()(),p(22,he,7,3,"div",34),n()()),a&2){let e=l(2);s(9),u(e.getRatePerMinute()),s(),m("ngIf",e.hasDailyMaxAmount()),s(6),u(e.formatDurationFromMinutes(e.quote.duration_minutes)),s(5),u(e.formatAmount(e.quote.net_amount)),s(),m("ngIf",e.quote.breakdown&&e.quote.breakdown.length>0)}}function fe(a,c){if(a&1&&(o(0,"div",14)(1,"div",15)(2,"fuse-card")(3,"div",16)(4,"h2",17),r(5,"Informaci\xF3n de Sesi\xF3n"),n(),o(6,"div",18)(7,"div")(8,"label",19),r(9,"ID de Sesi\xF3n"),n(),o(10,"p",20),r(11),n()(),o(12,"div")(13,"label",19),r(14,"Patente"),n(),o(15,"p",21),r(16),n()(),o(17,"div")(18,"label",19),r(19,"Sector"),n(),o(20,"p",20),r(21),n()(),o(22,"div")(23,"label",19),r(24,"Calle"),n(),o(25,"p",20),r(26),n()(),o(27,"div")(28,"label",19),r(29,"Operador"),n(),o(30,"p",20),r(31),n()(),o(32,"div")(33,"label",19),r(34,"Estado"),n(),o(35,"span",22),r(36),n()(),o(37,"div")(38,"label",19),r(39,"Inicio"),n(),o(40,"p",20),r(41),n()(),p(42,me,5,1,"div",23),n()()()(),o(43,"div",24),p(44,le,5,0,"fuse-card",23)(45,ge,23,5,"fuse-card",23),n()()),a&2){let e=l();s(11),u(e.session.id),s(5),u(e.session.plate),s(5),u((e.session.sector==null?null:e.session.sector.name)||"N/A"),s(5),u((e.session.street==null?null:e.session.street.name)||"N/A"),s(5),u((e.session.operator==null?null:e.session.operator.name)||"N/A"),s(5),S(" ",e.session.status," "),s(5),u(e.formatDateTime(e.session.started_at)),s(),m("ngIf",e.session.ended_at),s(2),m("ngIf",e.calculating),s(),m("ngIf",!e.calculating&&e.quote)}}var Qe=(()=>{class a{constructor(e,t,i,h,ie,ne,oe,re){this.route=e,this.router=t,this.fb=i,this.sessionService=h,this.printerService=ie,this.snackBar=ne,this.confirmationService=oe,this.dialog=re,this._unsubscribeAll=new y,this.session=null,this.loading=!1,this.error=null,this.calculating=!1,this.quote=null,this.breakdownExpanded=!1,this.checkoutForm=this.createForm()}ngOnInit(){this.loadSession()}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}createForm(){return this.fb.group({discount_code:[""],notes:[""],payment_method:["CASH",C.required],amount:["0",[C.required,C.min(0)]]})}loadSession(){let e=this.route.snapshot.paramMap.get("id");if(!e){this.router.navigate(["/parking/sessions"]);return}this.loading=!0,this.error=null,this.sessionService.getSession(+e).pipe(g(this._unsubscribeAll)).subscribe({next:t=>{if(this.session=t.data,this.session?.status!=="ACTIVE"){this.snackBar.open("Solo se puede hacer checkout de sesiones activas","Cerrar",{duration:3e3}),this.router.navigate(["/parking/sessions"]);return}this.loadQuote(),this.loading=!1},error:t=>{this.error="Error al cargar sesi\xF3n",this.loading=!1,console.error("Error loading session:",t),this.snackBar.open("Error al cargar sesi\xF3n","Cerrar",{duration:3e3})}})}loadQuote(){if(!this.session)return;this.calculating=!0;let e=new Date().toISOString();this.sessionService.getQuote(this.session.id,{ended_at:e}).pipe(g(this._unsubscribeAll)).subscribe({next:t=>{this.quote=t.data,this.calculating=!1,this.onPaymentMethodChange()},error:t=>{this.calculating=!1,console.error("Error calculating quote:",t),this.snackBar.open("Error al calcular cotizaci\xF3n","Cerrar",{duration:3e3})}})}onApplyDiscount(){if(!this.session||!this.checkoutForm.get("discount_code")?.value)return;this.calculating=!0;let e=this.checkoutForm.get("discount_code")?.value,t=new Date().toISOString();this.sessionService.getQuote(this.session.id,{ended_at:t,discount_code:e}).pipe(g(this._unsubscribeAll)).subscribe({next:i=>{this.quote=i.data,this.calculating=!1,this.snackBar.open("Descuento aplicado correctamente","Cerrar",{duration:3e3})},error:i=>{this.calculating=!1,console.error("Error applying discount:",i),this.snackBar.open("Error al aplicar descuento","Cerrar",{duration:3e3})}})}onCheckout(){if(!this.session||!this.quote)return;this.confirmationService.open({title:"Confirmar Checkout",message:`\xBFEst\xE1 seguro de procesar el checkout para la placa ${this.session.plate}?<br>
                <strong>Monto a cobrar:</strong> ${this.formatAmount(this.quote.net_amount)}`,icon:{show:!0,name:"heroicons_outline:currency-dollar",color:"primary"},actions:{confirm:{show:!0,label:"Procesar Checkout",color:"primary"},cancel:{show:!0,label:"Cancelar"}}}).afterClosed().subscribe(t=>{t==="confirmed"&&this.processCheckout()})}processCheckout(){if(!this.session||!this.checkoutForm.valid)return;this.loading=!0;let e={payment_method:this.checkoutForm.get("payment_method")?.value,amount:this.getNumericAmount(),discount_code:this.checkoutForm.get("discount_code")?.value||null,notes:this.checkoutForm.get("notes")?.value||null};this.sessionService.checkoutSession(this.session.id,e).pipe(g(this._unsubscribeAll)).subscribe({next:t=>{this.loading=!1,this.snackBar.open("Checkout procesado exitosamente","Cerrar",{duration:3e3}),this.printExitTicket(t.data,e),this.router.navigate(["/parking/sessions"])},error:t=>{this.loading=!1,console.error("Error processing checkout:",t),this.snackBar.open("Error al procesar checkout","Cerrar",{duration:3e3})}})}onBack(){let e=this.route.snapshot.paramMap.get("id");e?this.router.navigate(["/parking/sessions",e]):this.router.navigate(["/parking/sessions"])}openPaymentModal(){if(!this.session||!this.quote){this.snackBar.open("No se puede procesar el pago sin datos de sesi\xF3n","Cerrar",{duration:3e3});return}this.dialog.open(te,{width:"800px",maxWidth:"95vw",maxHeight:"90vh",data:{session:this.session,quote:this.quote},disableClose:!1}).afterClosed().subscribe(t=>{t?.success&&(this.loadSession(),this.snackBar.open("Pago procesado exitosamente","Cerrar",{duration:3e3}),this.router.navigate(["/parking/sessions"]))})}formatAmount(e){return this.sessionService.formatAmount(e)}formatDate(e){return new Date(e).toLocaleString("es-CL")}formatDateTime(e){if(!e)return"N/A";let t=new Date(e);if(isNaN(t.getTime()))return"N/A";let i=t.toLocaleDateString("es-CL",{day:"2-digit",month:"2-digit",year:"2-digit"}),h=t.toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit",hour12:!1});return`${i} ${h}`}formatDuration(e){return this.sessionService.formatDuration(e)}formatDurationFromMinutes(e){if(e<60)return`${Math.round(e)} minutos`;{let t=Math.floor(e/60),i=Math.round(e%60);return i===0?`${t} hora${t>1?"s":""}`:`${t} hora${t>1?"s":""} ${i} minuto${i>1?"s":""}`}}getStatusLabel(e){return this.sessionService.getStatusLabel(e)}getStatusColor(e){return this.sessionService.getStatusColor(e)}getNumericAmount(){let e=this.checkoutForm.get("amount")?.value;return typeof e=="string"?parseInt(e.replace(/[^\d]/g,""))||0:e||0}calculateChange(){let e=this.checkoutForm.get("payment_method")?.value,t=this.getNumericAmount(),i=this.quote?.net_amount||0;return e==="CASH"&&t>i?t-i:0}calculateAmountMissing(){let e=this.checkoutForm.get("payment_method")?.value,t=this.getNumericAmount(),i=this.quote?.net_amount||0;return e==="CASH"&&t<i?i-t:0}shouldShowChange(){let e=this.checkoutForm.get("payment_method")?.value,t=this.getNumericAmount(),i=this.quote?.net_amount||0;return e==="CASH"&&t>i}shouldShowMissingAmount(){let e=this.checkoutForm.get("payment_method")?.value,t=this.getNumericAmount(),i=this.quote?.net_amount||0;return e==="CASH"&&t<i}isAmountInsufficient(){let e=this.checkoutForm.get("payment_method")?.value,t=this.getNumericAmount(),i=this.quote?.net_amount||0;return e==="CASH"&&t<i}validateAmountSufficient(e){let t=e.value,i=this.checkoutForm?.get("payment_method")?.value,h=this.quote?.net_amount||0;return i==="CASH"&&t<h?{insufficientAmount:!0}:null}getAmountErrorMessage(){let e=this.checkoutForm.get("amount");if(e?.hasError("required"))return"El monto es requerido";if(e?.hasError("min"))return"El monto debe ser mayor a 0";if(e?.hasError("insufficientAmount")){let t=this.quote?.net_amount||0;return`El monto debe ser al menos ${this.formatAmount(t)}`}return""}formatCurrencyInput(e){let t=e.target,i=t.value.replace(/[^\d]/g,"");if(i){let h=parseInt(i).toLocaleString("es-CL");t.value=h,this.checkoutForm.patchValue({amount:parseInt(i)})}else this.checkoutForm.patchValue({amount:0})}updateAmountField(e){let t=e.toLocaleString("es-CL");this.checkoutForm.patchValue({amount:t})}fillExactAmount(){this.quote?.net_amount&&this.updateAmountField(this.quote.net_amount)}onAmountBlur(){let t=this.checkoutForm.get("amount")?.value;if(t&&typeof t=="string"){let i=parseInt(t.replace(/[^\d]/g,""));i&&this.checkoutForm.patchValue({amount:i})}}getCurrentTime(){return new Date().toLocaleString("es-CL")}onPaymentMethodChange(){this.checkoutForm.get("payment_method")?.value==="CASH"?(this.checkoutForm.get("amount")?.setValue("0"),this.checkoutForm.get("amount")?.enable()):this.quote?.net_amount&&(this.updateAmountField(this.quote.net_amount),this.checkoutForm.get("amount")?.disable())}getRatePerMinute(){if(!this.quote?.breakdown||this.quote.breakdown.length===0)return"N/A";let e=this.quote.breakdown.find(t=>t.rate_per_minute&&t.rate_per_minute>0);return e?this.formatAmount(e.rate_per_minute)+"/min":"N/A"}hasDailyMaxAmount(){return!this.quote?.breakdown||this.quote.breakdown.length===0?!1:this.quote.breakdown.some(e=>e.daily_max_amount&&e.daily_max_amount>0)}getDailyMaxAmount(){if(!this.quote?.breakdown||this.quote.breakdown.length===0)return"N/A";let e=this.quote.breakdown.find(t=>t.daily_max_amount&&t.daily_max_amount>0);return e?this.formatAmount(e.daily_max_amount):"N/A"}isAmountFieldDisabled(){return this.checkoutForm.get("payment_method")?.value!=="CASH"}toggleBreakdown(){this.breakdownExpanded=!this.breakdownExpanded,console.log("Breakdown expanded:",this.breakdownExpanded)}printExitTicket(e,t){this.quote&&this.printerService.printExitTicket(e,this.quote,t).pipe(g(this._unsubscribeAll)).subscribe({next:i=>{i.printed?this.snackBar.open("Ticket de salida impreso exitosamente","Cerrar",{duration:3e3}):this.snackBar.open(i.message,"Cerrar",{duration:5e3})},error:i=>{console.error("Error printing exit ticket:",i),this.snackBar.open("Error al imprimir ticket de salida","Cerrar",{duration:3e3})}})}static{this.\u0275fac=function(t){return new(t||a)(d(q),d(T),d(H),d(X),d(ee),d(U),d($),d(D))}}static{this.\u0275cmp=E({type:a,selectors:[["app-checkout"]],decls:11,vars:4,consts:[[1,"max-w-7xl","mx-auto","p-6"],[1,"flex","justify-between","items-center","mb-6"],[1,"text-2xl","font-bold","text-gray-900"],[1,"text-gray-600"],["mat-raised-button","","color","primary","class","rounded-sm",3,"click",4,"ngIf"],["class","text-center py-8",4,"ngIf"],["class","grid grid-cols-1 lg:grid-cols-5 gap-6",4,"ngIf"],["mat-raised-button","","color","primary",1,"rounded-sm",3,"click"],[1,"text-center","py-8"],["diameter","40"],[1,"mt-4","text-gray-600"],[1,"text-red-500","text-6xl","mb-4"],[1,"text-xl","font-semibold","text-gray-900","mb-2"],[1,"text-gray-600","mb-4"],[1,"grid","grid-cols-1","lg:grid-cols-5","gap-6"],[1,"lg:col-span-2"],[1,"p-6"],[1,"text-lg","font-semibold","text-gray-900","mb-4"],[1,"space-y-4"],[1,"text-sm","font-medium","text-gray-500"],[1,"text-gray-900"],[1,"text-gray-900","font-mono","text-lg"],[1,"px-2","py-1","rounded","text-xs","font-medium","bg-green-100","text-green-800"],[4,"ngIf"],[1,"lg:col-span-3"],[1,"p-6","text-center"],["diameter","30"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4","mb-4"],[1,"bg-gray-50","rounded-lg","p-3"],[1,"text-lg","font-semibold","text-gray-900"],["class","bg-gray-50 rounded-lg p-3",4,"ngIf"],[1,"bg-primary-50","border","border-primary-200","rounded-lg","p-3"],[1,"text-sm","font-medium","text-primary-700"],[1,"text-2xl","font-bold","text-primary-900"],["class","mt-4",4,"ngIf"],[1,"text-lg","font-semibold","text-orange-600"],[1,"mt-4"],["type","button",1,"flex","items-center","justify-between","w-full","text-sm","font-semibold","text-gray-700","mb-2","p-2","rounded","hover:bg-gray-100","transition-colors",3,"click"],[1,"text-gray-500",2,"transition","transform 0.2s ease"],["class","space-y-2",4,"ngIf"],[1,"space-y-2"],["class","flex justify-between items-center text-sm bg-white p-2 rounded border",3,"class",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-center","text-sm","bg-white","p-2","rounded","border"],[1,"font-medium"]],template:function(t,i){t&1&&(o(0,"div",0)(1,"div",1)(2,"div")(3,"h1",2),r(4,"Checkout de Sesi\xF3n"),n(),o(5,"p",3),r(6,"Finalizar sesi\xF3n de estacionamiento"),n()(),p(7,ae,4,0,"button",4),n(),p(8,se,4,0,"div",5)(9,ue,11,1,"div",5)(10,fe,46,10,"div",6),n()),t&2&&(s(7),m("ngIf",i.session&&!i.loading&&i.quote),s(),m("ngIf",i.loading),s(),m("ngIf",i.error),s(),m("ngIf",i.session&&!i.loading))},dependencies:[w,I,F,O,V,P,L,j,Z,N,R,K,W,Q,G,z,Y,B,J],encapsulation:2})}}return a})();export{Qe as CheckoutComponent};
