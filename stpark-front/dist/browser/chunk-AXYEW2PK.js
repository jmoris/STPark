import{a as ne}from"./chunk-Y33ASIMI.js";import{a as Z,b as ee}from"./chunk-FGUURFJS.js";import{a as te,b as oe}from"./chunk-3FSLCT73.js";import{a as I,b as A}from"./chunk-ZMKJJYLL.js";import{b as O,c as B}from"./chunk-72F6PA3H.js";import{d as K,e as W}from"./chunk-F2IYN6IZ.js";import{b as q,c as P,e as T,j as w,k as D}from"./chunk-EO526QJS.js";import{a as X,b as Y}from"./chunk-6JXRNXI3.js";import{B as J,b as H,d as x,f as R,g as z,k as G,l as Q,n as L,q as U,y as $}from"./chunk-XMMUWBM2.js";import{fa as F,la as N,na as V,oa as j}from"./chunk-56JILNRZ.js";import{m as k,t as E}from"./chunk-IZAOXH6X.js";import{$b as h,Eb as l,Pb as t,Qb as o,Rb as v,U as b,bb as m,bc as p,cb as d,f as M,mc as a,nc as _,oc as f,pb as S,wb as c}from"./chunk-QDWFRTQW.js";function ie(r,u){if(r&1&&(t(0,"p",28),a(1),o()),r&2){let e=p();m(),f(" Descuento aplicado: -",e.formatAmount(e.quote.discount_amount)," ")}}function ae(r,u){if(r&1&&(t(0,"p",29),a(1),o()),r&2){let e=p();m(),f(" ",e.data.selectedDiscount.name," ")}}function re(r,u){r&1&&(t(0,"mat-error"),a(1," El m\xE9todo de pago es requerido "),o())}function me(r,u){r&1&&(t(0,"mat-error"),a(1," El monto es requerido "),o())}function le(r,u){r&1&&(t(0,"mat-error"),a(1," El monto debe ser mayor a 0 "),o())}function se(r,u){if(r&1&&(t(0,"div",33)(1,"div",34)(2,"div",35)(3,"mat-icon",36),a(4,"monetization_on"),o(),t(5,"span",37),a(6,"Vuelto a entregar:"),o()(),t(7,"span",38),a(8),o()()()),r&2){let e=p(2);m(8),_(e.formatAmount(e.calculateChange()))}}function ue(r,u){if(r&1&&(t(0,"div",39)(1,"div",34)(2,"div",35)(3,"mat-icon",40),a(4,"warning"),o(),t(5,"span",41),a(6,"Monto faltante:"),o()(),t(7,"span",42),a(8),o()()()),r&2){let e=p(2);m(8),_(e.formatAmount(e.calculateAmountMissing()))}}function ce(r,u){if(r&1&&(t(0,"div",30),c(1,se,9,1,"div",31)(2,ue,9,1,"div",32),o()),r&2){let e=p();m(),l("ngIf",e.shouldShowChange()),m(),l("ngIf",e.shouldShowMissingAmount())}}function de(r,u){r&1&&v(0,"mat-spinner",43)}function pe(r,u){r&1&&(t(0,"mat-icon"),a(1,"payment"),o())}var Oe=(()=>{class r{constructor(e,n,i,s,g){this.dialogRef=e,this.data=n,this.fb=i,this.sessionService=s,this.snackBar=g,this._unsubscribeAll=new M,this.quote=null,this.processing=!1,this.session=n.session,this.quote=n.quote,this.checkoutForm=this.createForm()}ngOnInit(){this.quote?this.initializeForm():this.loadQuote()}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}createForm(){return this.fb.group({payment_method:["CASH",x.required],amount:["",[x.required,x.min(0)]],notes:[""]})}initializeForm(){this.quote&&(this.checkoutForm.get("payment_method")?.value==="CASH"?this.checkoutForm.patchValue({amount:""}):this.checkoutForm.patchValue({amount:this.quote.net_amount}))}loadQuote(){if(!this.session)return;let e=new Date().toISOString();this.sessionService.getQuote(this.session.id,{ended_at:e}).pipe(b(this._unsubscribeAll)).subscribe({next:n=>{this.quote=n.data,this.initializeForm()},error:n=>{console.error("Error loading quote:",n),this.snackBar.open("Error al cargar la cotizaci\xF3n","Cerrar",{duration:3e3})}})}onPaymentMethodChange(){this.checkoutForm.get("payment_method")?.value==="CASH"?this.checkoutForm.patchValue({amount:""}):this.checkoutForm.patchValue({amount:this.quote?.net_amount||0})}isAmountFieldDisabled(){return this.checkoutForm.get("payment_method")?.value!=="CASH"}shouldShowChange(){let e=this.checkoutForm.get("payment_method")?.value,n=this.checkoutForm.get("amount")?.value,i=n===""||n===null||n===void 0?0:typeof n=="string"?parseFloat(n)||0:Number(n)||0;return e==="CASH"&&i>(this.quote?.net_amount||0)}shouldShowMissingAmount(){let e=this.checkoutForm.get("payment_method")?.value,n=this.checkoutForm.get("amount")?.value,i=n===""||n===null||n===void 0?0:typeof n=="string"?parseFloat(n)||0:Number(n)||0;return e==="CASH"&&i<(this.quote?.net_amount||0)}calculateChange(){let e=this.checkoutForm.get("amount")?.value;return(e===""||e===null||e===void 0?0:typeof e=="string"?parseFloat(e)||0:Number(e)||0)-(this.quote?.net_amount||0)}calculateAmountMissing(){let e=this.checkoutForm.get("amount")?.value,n=e===""||e===null||e===void 0?0:typeof e=="string"?parseFloat(e)||0:Number(e)||0;return(this.quote?.net_amount||0)-n}formatAmount(e){return this.sessionService.formatAmount(e)}onSubmit(){if(this.checkoutForm.invalid||!this.quote)return;this.processing=!0;let e=this.checkoutForm.value,n=0;e.amount!==""&&e.amount!==null&&e.amount!==void 0&&(n=typeof e.amount=="string"?parseFloat(e.amount)||0:Number(e.amount)||0);let i={amount:n,payment_method:e.payment_method,notes:e.notes||null,operator_id:this.session.operator_in_id};this.quote?.discount_id?i.discount_id=this.quote.discount_id:this.data.selectedDiscount?.id&&(i.discount_id=this.data.selectedDiscount.id),this.sessionService.checkoutSession(this.session.id,i).pipe(b(this._unsubscribeAll)).subscribe({next:s=>{this.processing=!1,this.snackBar.open("Pago procesado exitosamente","Cerrar",{duration:3e3}),this.dialogRef.close({success:!0,data:s.data})},error:s=>{this.processing=!1,console.error("Error processing payment:",s),this.snackBar.open("Error al procesar el pago","Cerrar",{duration:3e3})}})}onClose(){this.dialogRef.close({success:!1})}static{this.\u0275fac=function(n){return new(n||r)(d(I),d(A),d($),d(ne),d(Z))}}static{this.\u0275cmp=S({type:r,selectors:[["app-checkout-modal"]],decls:56,vars:14,consts:[[1,"checkout-modal"],[1,"flex","items-center","justify-between","p-6","border-b","border-gray-200","bg-gray-50","rounded-t-lg"],[1,"flex","items-center","gap-3"],[1,"text-blue-600"],[1,"text-xl","font-semibold","text-gray-900"],[1,"text-sm","text-gray-600"],["mat-icon-button","",1,"text-gray-500","hover:text-gray-700",3,"click"],[1,"p-6"],[1,"bg-primary-50","border","border-primary-200","rounded-lg","p-6","mb-6","text-center"],[1,"text-lg","font-semibold","text-primary-700","mb-2"],[1,"text-4xl","font-bold","text-primary-900"],["class","text-sm text-green-600 mt-2",4,"ngIf"],["class","text-xs text-blue-600 mt-1",4,"ngIf"],[1,"space-y-6",3,"ngSubmit","formGroup"],["appearance","outline",1,"w-full"],["formControlName","payment_method",3,"selectionChange"],["value","CASH"],["value","CARD"],["value","TRANSFER"],[4,"ngIf"],["matInput","","type","number","formControlName","amount","placeholder","0",3,"readonly"],["matPrefix",""],["class","space-y-3",4,"ngIf"],["matInput","","formControlName","notes","rows","3","placeholder","Observaciones adicionales..."],[1,"flex","flex-col","sm:flex-row","gap-3","justify-end","pt-4"],["type","button","mat-stroked-button","",1,"rounded-sm",3,"click"],["type","submit","mat-raised-button","","color","primary",1,"rounded-sm",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],[1,"text-sm","text-green-600","mt-2"],[1,"text-xs","text-blue-600","mt-1"],[1,"space-y-3"],["class","bg-green-50 border border-green-200 rounded-lg p-4",4,"ngIf"],["class","bg-red-50 border border-red-200 rounded-lg p-4",4,"ngIf"],[1,"bg-green-50","border","border-green-200","rounded-lg","p-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],[1,"text-green-600"],[1,"text-green-800","font-semibold"],[1,"text-xl","font-bold","text-green-700"],[1,"bg-red-50","border","border-red-200","rounded-lg","p-4"],[1,"text-red-600"],[1,"text-red-800","font-semibold"],[1,"text-xl","font-bold","text-red-700"],["diameter","20",1,"mr-2"]],template:function(n,i){if(n&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"mat-icon",3),a(4,"payment"),o(),t(5,"div")(6,"h2",4),a(7," Procesar Pago "),o(),t(8,"p",5),a(9),o()()(),t(10,"button",6),h("click",function(){return i.onClose()}),t(11,"mat-icon"),a(12,"close"),o()()(),t(13,"div",7)(14,"div",8)(15,"h3",9),a(16,"Total a Pagar"),o(),t(17,"p",10),a(18),o(),c(19,ie,2,1,"p",11)(20,ae,2,1,"p",12),o(),t(21,"form",13),h("ngSubmit",function(){return i.onSubmit()}),t(22,"mat-form-field",14)(23,"mat-label"),a(24,"M\xE9todo de Pago"),o(),t(25,"mat-select",15),h("selectionChange",function(){return i.onPaymentMethodChange()}),t(26,"mat-option",16),a(27,"Efectivo"),o(),t(28,"mat-option",17),a(29,"Tarjeta"),o(),t(30,"mat-option",18),a(31,"Transferencia"),o()(),c(32,re,2,0,"mat-error",19),o(),t(33,"mat-form-field",14)(34,"mat-label"),a(35,"Monto Pagado"),o(),v(36,"input",20),t(37,"span",21),a(38,"$\xA0"),o(),c(39,me,2,0,"mat-error",19)(40,le,2,0,"mat-error",19),o(),c(41,ce,3,2,"div",22),t(42,"mat-form-field",14)(43,"mat-label"),a(44,"Notas (opcional)"),o(),t(45,"textarea",23),a(46,"        "),o()(),t(47,"div",24)(48,"button",25),h("click",function(){return i.onClose()}),t(49,"mat-icon"),a(50,"close"),o(),a(51," Cancelar "),o(),t(52,"button",26),c(53,de,1,0,"mat-spinner",27)(54,pe,2,0,"mat-icon",19),a(55),o()()()()()),n&2){let s,g,C,y;m(9),f("Placa: ",i.session.plate,""),m(9),_(i.formatAmount(i.quote.net_amount)),m(),l("ngIf",i.quote.discount_amount&&i.quote.discount_amount>0),m(),l("ngIf",i.data.selectedDiscount),m(),l("formGroup",i.checkoutForm),m(11),l("ngIf",(s=i.checkoutForm.get("payment_method"))==null?null:s.hasError("required")),m(4),l("readonly",i.isAmountFieldDisabled()),m(3),l("ngIf",(g=i.checkoutForm.get("amount"))==null?null:g.hasError("required")),m(),l("ngIf",(C=i.checkoutForm.get("amount"))==null?null:C.hasError("min")),m(),l("ngIf",((y=i.checkoutForm.get("payment_method"))==null?null:y.value)==="CASH"),m(11),l("disabled",i.checkoutForm.invalid||i.processing),m(),l("ngIf",i.processing),m(),l("ngIf",!i.processing),m(),f(" ",i.processing?"Procesando...":"Confirmar Pago"," ")}},dependencies:[E,k,J,G,H,Q,R,z,L,U,j,N,V,B,O,D,w,q,P,T,W,K,oe,te,F,Y,X,ee],styles:[".checkout-modal[_ngcontent-%COMP%]{width:100%;max-width:500px;margin:0 auto}.mat-mdc-form-field[_ngcontent-%COMP%]{width:100%}.mat-mdc-button[_ngcontent-%COMP%]{border-radius:4px!important}.mat-mdc-progress-spinner[_ngcontent-%COMP%]{margin-right:8px}@media (max-width: 640px){.checkout-modal[_ngcontent-%COMP%]{max-width:95vw}}"]})}}return r})();export{Oe as a};
