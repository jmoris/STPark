import{a as te}from"./chunk-VUFBSA72.js";import{a as Z,b as ee}from"./chunk-PPJSSJVV.js";import{a as oe,b as ne}from"./chunk-K7CKQB5A.js";import{a as I,b as A}from"./chunk-JIUYXI52.js";import{a as X,b as Y}from"./chunk-TRMB4HP7.js";import{b as q,c as P,e as w,j as T,k as D,o as K,p as W}from"./chunk-O3EC65OG.js";import{b as H,d as _,f as R,g as z,k as G,l as Q,n as L,o as U,v as $,y as J}from"./chunk-EGGCURRC.js";import{ea as F,ka as N,ma as O,na as j,pa as B,qa as V}from"./chunk-QNFMCERA.js";import{m as k,s as E}from"./chunk-TQARHOKX.js";import{$b as p,Eb as l,Pb as e,Qb as t,Rb as b,U as x,bb as m,bc as f,cb as u,f as M,mc as n,nc as g,oc as v,pb as y,wb as d}from"./chunk-BSJZAB7M.js";function ie(r,c){r&1&&(e(0,"mat-error"),n(1," El m\xE9todo de pago es requerido "),t())}function re(r,c){r&1&&(e(0,"mat-error"),n(1," El monto es requerido "),t())}function ae(r,c){r&1&&(e(0,"mat-error"),n(1," El monto debe ser mayor a 0 "),t())}function me(r,c){if(r&1&&(e(0,"div",29)(1,"div",30)(2,"div",31)(3,"mat-icon",32),n(4,"monetization_on"),t(),e(5,"span",33),n(6,"Vuelto a entregar:"),t()(),e(7,"span",34),n(8),t()()()),r&2){let o=f(2);m(8),g(o.formatAmount(o.calculateChange()))}}function le(r,c){if(r&1&&(e(0,"div",35)(1,"div",30)(2,"div",31)(3,"mat-icon",36),n(4,"warning"),t(),e(5,"span",37),n(6,"Monto faltante:"),t()(),e(7,"span",38),n(8),t()()()),r&2){let o=f(2);m(8),g(o.formatAmount(o.calculateAmountMissing()))}}function se(r,c){if(r&1&&(e(0,"div",26),d(1,me,9,1,"div",27)(2,le,9,1,"div",28),t()),r&2){let o=f();m(),l("ngIf",o.shouldShowChange()),m(),l("ngIf",o.shouldShowMissingAmount())}}function ce(r,c){r&1&&b(0,"mat-spinner",39)}function ue(r,c){r&1&&(e(0,"mat-icon"),n(1,"payment"),t())}var Oe=(()=>{class r{constructor(o,a,i,s,h){this.dialogRef=o,this.data=a,this.fb=i,this.sessionService=s,this.snackBar=h,this._unsubscribeAll=new M,this.quote=null,this.processing=!1,this.session=a.session,this.quote=a.quote,this.checkoutForm=this.createForm()}ngOnInit(){this.quote?this.initializeForm():this.loadQuote()}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}createForm(){return this.fb.group({payment_method:["CASH",_.required],amount:["0",[_.required,_.min(0)]],notes:[""]})}initializeForm(){this.quote&&(this.checkoutForm.get("payment_method")?.value==="CASH"?this.checkoutForm.patchValue({amount:0}):this.checkoutForm.patchValue({amount:this.quote.net_amount}))}loadQuote(){if(!this.session)return;let o=new Date().toISOString();this.sessionService.getQuote(this.session.id,{ended_at:o}).pipe(x(this._unsubscribeAll)).subscribe({next:a=>{this.quote=a.data,this.initializeForm()},error:a=>{console.error("Error loading quote:",a),this.snackBar.open("Error al cargar la cotizaci\xF3n","Cerrar",{duration:3e3})}})}onPaymentMethodChange(){this.checkoutForm.get("payment_method")?.value==="CASH"?this.checkoutForm.patchValue({amount:0}):this.checkoutForm.patchValue({amount:this.quote?.net_amount||0})}isAmountFieldDisabled(){return this.checkoutForm.get("payment_method")?.value!=="CASH"}shouldShowChange(){let o=this.checkoutForm.get("payment_method")?.value,a=this.checkoutForm.get("amount")?.value||0;return o==="CASH"&&a>this.quote?.net_amount}shouldShowMissingAmount(){let o=this.checkoutForm.get("payment_method")?.value,a=this.checkoutForm.get("amount")?.value||0;return o==="CASH"&&a<this.quote?.net_amount}calculateChange(){return(this.checkoutForm.get("amount")?.value||0)-this.quote?.net_amount}calculateAmountMissing(){let o=this.checkoutForm.get("amount")?.value||0;return this.quote?.net_amount-o}formatAmount(o){return this.sessionService.formatAmount(o)}onSubmit(){if(this.checkoutForm.invalid||!this.quote)return;this.processing=!0;let o=this.checkoutForm.value,a={session_id:this.session.id,amount:o.amount,payment_method:o.payment_method,notes:o.notes,ended_at:new Date().toISOString()};this.sessionService.checkoutSession(this.session.id,a).pipe(x(this._unsubscribeAll)).subscribe({next:i=>{this.processing=!1,this.snackBar.open("Pago procesado exitosamente","Cerrar",{duration:3e3}),this.dialogRef.close({success:!0,data:i.data})},error:i=>{this.processing=!1,console.error("Error processing payment:",i),this.snackBar.open("Error al procesar el pago","Cerrar",{duration:3e3})}})}onClose(){this.dialogRef.close({success:!1})}static{this.\u0275fac=function(a){return new(a||r)(u(I),u(A),u($),u(te),u(oe))}}static{this.\u0275cmp=y({type:r,selectors:[["app-checkout-modal"]],decls:54,vars:12,consts:[[1,"checkout-modal"],[1,"flex","items-center","justify-between","p-6","border-b","border-gray-200","bg-gray-50","rounded-t-lg"],[1,"flex","items-center","gap-3"],[1,"text-blue-600"],[1,"text-xl","font-semibold","text-gray-900"],[1,"text-sm","text-gray-600"],["mat-icon-button","",1,"text-gray-500","hover:text-gray-700",3,"click"],[1,"p-6"],[1,"bg-primary-50","border","border-primary-200","rounded-lg","p-6","mb-6","text-center"],[1,"text-lg","font-semibold","text-primary-700","mb-2"],[1,"text-4xl","font-bold","text-primary-900"],[1,"space-y-6",3,"ngSubmit","formGroup"],["appearance","outline",1,"w-full"],["formControlName","payment_method",3,"selectionChange"],["value","CASH"],["value","CARD"],["value","TRANSFER"],[4,"ngIf"],["matInput","","type","number","formControlName","amount","placeholder","0",3,"readonly"],["matPrefix",""],["class","space-y-3",4,"ngIf"],["matInput","","formControlName","notes","rows","3","placeholder","Observaciones adicionales..."],[1,"flex","flex-col","sm:flex-row","gap-3","justify-end","pt-4"],["type","button","mat-stroked-button","",1,"rounded-sm",3,"click"],["type","submit","mat-raised-button","","color","primary",1,"rounded-sm",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],[1,"space-y-3"],["class","bg-green-50 border border-green-200 rounded-lg p-4",4,"ngIf"],["class","bg-red-50 border border-red-200 rounded-lg p-4",4,"ngIf"],[1,"bg-green-50","border","border-green-200","rounded-lg","p-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],[1,"text-green-600"],[1,"text-green-800","font-semibold"],[1,"text-xl","font-bold","text-green-700"],[1,"bg-red-50","border","border-red-200","rounded-lg","p-4"],[1,"text-red-600"],[1,"text-red-800","font-semibold"],[1,"text-xl","font-bold","text-red-700"],["diameter","20",1,"mr-2"]],template:function(a,i){if(a&1&&(e(0,"div",0)(1,"div",1)(2,"div",2)(3,"mat-icon",3),n(4,"payment"),t(),e(5,"div")(6,"h2",4),n(7," Procesar Pago "),t(),e(8,"p",5),n(9),t()()(),e(10,"button",6),p("click",function(){return i.onClose()}),e(11,"mat-icon"),n(12,"close"),t()()(),e(13,"div",7)(14,"div",8)(15,"h3",9),n(16,"Total a Pagar"),t(),e(17,"p",10),n(18),t()(),e(19,"form",11),p("ngSubmit",function(){return i.onSubmit()}),e(20,"mat-form-field",12)(21,"mat-label"),n(22,"M\xE9todo de Pago"),t(),e(23,"mat-select",13),p("selectionChange",function(){return i.onPaymentMethodChange()}),e(24,"mat-option",14),n(25,"Efectivo"),t(),e(26,"mat-option",15),n(27,"Tarjeta"),t(),e(28,"mat-option",16),n(29,"Transferencia"),t()(),d(30,ie,2,0,"mat-error",17),t(),e(31,"mat-form-field",12)(32,"mat-label"),n(33,"Monto Pagado"),t(),b(34,"input",18),e(35,"span",19),n(36,"$\xA0"),t(),d(37,re,2,0,"mat-error",17)(38,ae,2,0,"mat-error",17),t(),d(39,se,3,2,"div",20),e(40,"mat-form-field",12)(41,"mat-label"),n(42,"Notas (opcional)"),t(),e(43,"textarea",21),n(44,"        "),t()(),e(45,"div",22)(46,"button",23),p("click",function(){return i.onClose()}),e(47,"mat-icon"),n(48,"close"),t(),n(49," Cancelar "),t(),e(50,"button",24),d(51,ce,1,0,"mat-spinner",25)(52,ue,2,0,"mat-icon",17),n(53),t()()()()()),a&2){let s,h,C,S;m(9),v("Placa: ",i.session.plate,""),m(9),g(i.formatAmount(i.quote.net_amount)),m(),l("formGroup",i.checkoutForm),m(11),l("ngIf",(s=i.checkoutForm.get("payment_method"))==null?null:s.hasError("required")),m(4),l("readonly",i.isAmountFieldDisabled()),m(3),l("ngIf",(h=i.checkoutForm.get("amount"))==null?null:h.hasError("required")),m(),l("ngIf",(C=i.checkoutForm.get("amount"))==null?null:C.hasError("min")),m(),l("ngIf",((S=i.checkoutForm.get("payment_method"))==null?null:S.value)==="CASH"),m(11),l("disabled",i.checkoutForm.invalid||i.processing),m(),l("ngIf",i.processing),m(),l("ngIf",!i.processing),m(),v(" ",i.processing?"Procesando...":"Confirmar Pago"," ")}},dependencies:[E,k,J,G,H,Q,R,z,L,U,j,N,O,V,B,D,T,q,P,w,W,K,ee,Z,F,Y,X,ne],styles:[".checkout-modal[_ngcontent-%COMP%]{width:100%;max-width:500px;margin:0 auto}.mat-mdc-form-field[_ngcontent-%COMP%]{width:100%}.mat-mdc-button[_ngcontent-%COMP%]{border-radius:4px!important}.mat-mdc-progress-spinner[_ngcontent-%COMP%]{margin-right:8px}@media (max-width: 640px){.checkout-modal[_ngcontent-%COMP%]{max-width:95vw}}"]})}}return r})();export{Oe as a};
