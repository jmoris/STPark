import{a as Ie}from"./chunk-ZWZQJAU5.js";import{o as he,q as ve,u as Me,v as Pe}from"./chunk-IS5LCSW4.js";import{a as Oe}from"./chunk-N6GZTNZA.js";import{a as ye}from"./chunk-N3PSIUVN.js";import{a as De}from"./chunk-QU4WFXUG.js";import{a as we}from"./chunk-ZMZZWBL4.js";import{f as Fe}from"./chunk-O24YRI2L.js";import{a as Ee}from"./chunk-LISAJ4W4.js";import{a as Se,b as xe}from"./chunk-7XMR7DBQ.js";import{_ as Ce}from"./chunk-GI2EMKD6.js";import{a as fe,b as be}from"./chunk-EQ3II6XW.js";import"./chunk-UF23LYQO.js";import"./chunk-VKB6BRO6.js";import{b as te,c as ne}from"./chunk-U3LSFXAC.js";import{d as pe,e as ue}from"./chunk-PKSNJV5O.js";import{a as ge,b as _e}from"./chunk-VKOFSPQJ.js";import{b as R,c as Z,d as Y,e as J,j as K,k as Q}from"./chunk-L3L2HYJX.js";import{b as ie,d as P,f as oe,g as re,k as ae,n as se,o as le,u as ce,v as de,y as me}from"./chunk-EGGCURRC.js";import{fa as H,la as X,oa as ee}from"./chunk-JXZZYULX.js";import"./chunk-2JMYS33K.js";import"./chunk-CQGOYTFO.js";import{d as G}from"./chunk-DOMNBE5L.js";import"./chunk-7OGW3PNS.js";import{l as I,m as $,s as A}from"./chunk-TQARHOKX.js";import{$b as b,Eb as l,Gb as k,Hb as L,Ib as W,Pb as t,Qb as n,Rb as v,U as f,Vb as q,bb as s,bc as p,cb as h,f as j,mc as o,nc as _,oa as S,oc as C,pa as x,pb as y,pc as N,qc as U,rc as F,sc as w,tc as D,vc as B,wb as u,ya as E}from"./chunk-BSJZAB7M.js";import"./chunk-TSRGIXR5.js";var Be=()=>({width:"50rem"}),Ve=()=>({"1199px":"70vw","575px":"90vw"});function ze(a,m){if(a&1&&(t(0,"div",26)(1,"div",27)(2,"div",28)(3,"div",29),v(4,"i",30),t(5,"span"),o(6),n()(),t(7,"div",31),o(8),n()(),t(9,"div",32)(10,"span",33),o(11),n(),t(12,"span",34),o(13),n()()()()),a&2){let e=m.$implicit,r=p();s(4),W(r.getOriginIcon(e.origin)),s(2),_(r.getOriginText(e.origin)),s(2),_(r.formatAmount(e.principal_amount)),s(3),C("ID: ",e.id,""),s(2),_(r.getDebtAge(e))}}function je(a,m){if(a&1){let e=q();t(0,"div",35)(1,"button",36),b("click",function(){S(e);let i=p();return x(i.closeModal())}),n(),t(2,"div",37)(3,"button",38),b("click",function(){S(e);let i=p();return x(i.onContinueWithoutPayment())}),n(),t(4,"button",39),b("click",function(){S(e);let i=p();return x(i.onPayDebts())}),n()()()}}var Ae=(()=>{class a{constructor(){this.visible=!1,this.debts=[],this.plate="",this.visibleChange=new E,this.payDebts=new E,this.continueWithoutPayment=new E}closeModal(){this.visible=!1,this.visibleChange.emit(!1)}onPayDebts(){this.payDebts.emit(),this.closeModal()}onContinueWithoutPayment(){this.continueWithoutPayment.emit(),this.closeModal()}formatAmount(e){return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0,maximumFractionDigits:0}).format(e).replace("CLP","$")}getTotalDebtAmount(){return this.debts.reduce((e,r)=>e+r.principal_amount,0)}getOriginText(e){switch(e){case"SESSION":return"Sesi\xF3n de Estacionamiento";case"FINE":return"Multa";case"MANUAL":return"Manual";default:return e}}getOriginIcon(e){switch(e){case"SESSION":return"pi-car";case"FINE":return"pi-exclamation-triangle";case"MANUAL":return"pi-user-edit";default:return"pi-question-circle"}}getDebtAge(e){let r=new Date(e.created_at),d=Math.abs(new Date().getTime()-r.getTime()),c=Math.ceil(d/(1e3*60*60*24));if(c===0)return"Hoy";if(c===1)return"Ayer";if(c<7)return`${c} d\xEDas`;if(c<30){let g=Math.floor(c/7);return`${g} semana${g>1?"s":""}`}let M=Math.floor(c/30);return`${M} mes${M>1?"es":""}`}static{this.\u0275fac=function(r){return new(r||a)}}static{this.\u0275cmp=y({type:a,selectors:[["app-debt-alert-modal"]],inputs:{visible:"visible",debts:"debts",plate:"plate"},outputs:{visibleChange:"visibleChange",payDebts:"payDebts",continueWithoutPayment:"continueWithoutPayment"},decls:49,vars:18,consts:[["header","\u26A0\uFE0F DEUDAS PENDIENTES DETECTADAS",3,"visibleChange","visible","modal","breakpoints","draggable","resizable","closable","closeOnEscape"],[1,"debt-alert-content"],[1,"alert-header"],[1,"plate-info"],[1,"pi","pi-car","plate-icon"],[1,"plate-text"],[1,"alert-message"],[1,"alert-title"],[1,"alert-subtitle"],[1,"debts-list"],[1,"debt-items"],["class","debt-item",4,"ngFor","ngForOf"],[1,"recommendation"],[1,"recommendation-content"],[1,"pi","pi-info-circle","recommendation-icon"],[1,"recommendation-text"],[1,"action-options"],[1,"option-card","pay-option"],[1,"option-header"],[1,"pi","pi-credit-card","option-icon"],[1,"option-description"],[1,"option-total"],[1,"option-card","continue-option"],[1,"pi","pi-play","option-icon"],[1,"option-warning"],["pTemplate","footer"],[1,"debt-item"],[1,"debt-info"],[1,"debt-header"],[1,"debt-origin"],[1,"origin-icon"],[1,"debt-amount"],[1,"debt-details"],[1,"debt-id"],[1,"debt-age"],[1,"flex","justify-between","w-full"],["pButton","","type","button","label","Cancelar","icon","pi pi-times",1,"p-button-text",3,"click"],[1,"flex","gap-2"],["pButton","","type","button","label","Continuar Sin Pagar","icon","pi pi-play",1,"p-button-outlined","p-button-warning",3,"click"],["pButton","","type","button","label","Liquidar Deudas","icon","pi pi-credit-card",1,"p-button-success",3,"click"]],template:function(r,i){r&1&&(t(0,"p-dialog",0),D("visibleChange",function(c){return w(i.visible,c)||(i.visible=c),c}),b("visibleChange",function(c){return i.visibleChange.emit(c)}),t(1,"div",1)(2,"div",2)(3,"div",3),v(4,"i",4),t(5,"span",5),o(6),n()(),t(7,"div",6)(8,"p",7),o(9,"Esta patente tiene deudas pendientes"),n(),t(10,"p",8),o(11),t(12,"strong"),o(13),n()()()(),t(14,"div",9)(15,"h4"),o(16,"Deudas Pendientes:"),n(),t(17,"div",10),u(18,ze,14,6,"div",11),n()(),t(19,"div",12)(20,"div",13),v(21,"i",14),t(22,"div",15)(23,"p")(24,"strong"),o(25,"Recomendaci\xF3n:"),n(),o(26," Te sugerimos liquidar las deudas pendientes antes de iniciar una nueva sesi\xF3n para evitar acumulaci\xF3n de intereses."),n()()()(),t(27,"div",16)(28,"div",17)(29,"div",18),v(30,"i",19),t(31,"h5"),o(32,"Liquidar Deudas"),n()(),t(33,"p",20),o(34,"Pagar todas las deudas pendientes antes de iniciar la nueva sesi\xF3n."),n(),t(35,"div",21),o(36," Total a pagar: "),t(37,"strong"),o(38),n()()(),t(39,"div",22)(40,"div",18),v(41,"i",23),t(42,"h5"),o(43,"Continuar Sin Pagar"),n()(),t(44,"p",20),o(45,"Iniciar la nueva sesi\xF3n sin liquidar las deudas pendientes."),n(),t(46,"div",24),o(47," \u26A0\uFE0F Las deudas seguir\xE1n pendientes "),n()()()(),u(48,je,5,0,"ng-template",25),n()),r&2&&(L(B(16,Be)),F("visible",i.visible),l("modal",!0)("breakpoints",B(17,Ve))("draggable",!1)("resizable",!1)("closable",!1)("closeOnEscape",!1),s(6),_(i.plate),s(5),U("Se encontraron ",i.debts.length," deuda",i.debts.length>1?"s":""," pendiente",i.debts.length>1?"s":""," por un total de "),s(2),_(i.formatAmount(i.getTotalDebtAmount())),s(5),l("ngForOf",i.debts),s(20),_(i.formatAmount(i.getTotalDebtAmount())))},dependencies:[A,I,Pe,Me,Ce,ve,he],styles:[".debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding:1rem;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:.75rem;border-left:4px solid #f59e0b}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;background:#fffc;padding:.75rem 1rem;border-radius:.5rem;box-shadow:0 2px 4px #0000001a}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]   .plate-icon[_ngcontent-%COMP%]{font-size:1.5rem;color:#1e40af}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]   .plate-text[_ngcontent-%COMP%]{font-family:Monaco,Menlo,Ubuntu Mono,monospace;font-size:1.25rem;font-weight:700;color:#1e40af;text-transform:uppercase;letter-spacing:.1em}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .alert-message[_ngcontent-%COMP%]{flex:1}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .alert-message[_ngcontent-%COMP%]   .alert-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;color:#92400e;margin:0 0 .25rem}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .alert-message[_ngcontent-%COMP%]   .alert-subtitle[_ngcontent-%COMP%]{font-size:.95rem;color:#a16207;margin:0}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]{margin-bottom:1.5rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:#374151;margin-bottom:.75rem;padding-bottom:.25rem;border-bottom:1px solid #e5e7eb}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-items[_ngcontent-%COMP%]{max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:.5rem;background:#f9fafb}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]{padding:.75rem;border-bottom:1px solid #e5e7eb;background:#fff;transition:background-color .2s ease}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]:hover{background:#f3f4f6}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]   .debt-origin[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;font-size:.9rem;color:#6b7280}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]   .debt-origin[_ngcontent-%COMP%]   .origin-icon[_ngcontent-%COMP%]{font-size:1rem;color:#9ca3af}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]   .debt-amount[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700;color:#dc2626}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-size:.8rem;color:#9ca3af}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]   .debt-id[_ngcontent-%COMP%]{font-family:Monaco,Menlo,Ubuntu Mono,monospace;background:#f3f4f6;padding:.125rem .375rem;border-radius:.25rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]   .debt-age[_ngcontent-%COMP%]{font-style:italic}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]{margin-bottom:1.5rem;padding:1rem;background:#eff6ff;border-radius:.5rem;border-left:4px solid #3b82f6}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:.75rem}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]   .recommendation-icon[_ngcontent-%COMP%]{font-size:1.25rem;color:#3b82f6;margin-top:.125rem}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]   .recommendation-text[_ngcontent-%COMP%]{flex:1}.debt-alert-content[_ngcontent-%COMP%]   .recommendation[_ngcontent-%COMP%]   .recommendation-content[_ngcontent-%COMP%]   .recommendation-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:.9rem;color:#1e40af;line-height:1.5}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]{padding:1rem;border-radius:.75rem;border:2px solid transparent;transition:all .2s ease;cursor:pointer}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #0000001a}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.pay-option[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:#22c55e}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.pay-option[_ngcontent-%COMP%]:hover{border-color:#16a34a;background:linear-gradient(135deg,#ecfdf5,#d1fae5)}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.continue-option[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fefce8,#fef3c7);border-color:#eab308}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card.continue-option[_ngcontent-%COMP%]:hover{border-color:#ca8a04;background:linear-gradient(135deg,#fef9c3,#fde68a)}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-header[_ngcontent-%COMP%]   .option-icon[_ngcontent-%COMP%]{font-size:1.25rem}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-header[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-description[_ngcontent-%COMP%]{font-size:.9rem;color:#6b7280;margin-bottom:.75rem;line-height:1.4}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-total[_ngcontent-%COMP%]{font-size:.9rem;color:#059669;font-weight:600}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]   .option-card[_ngcontent-%COMP%]   .option-warning[_ngcontent-%COMP%]{font-size:.9rem;color:#d97706;font-weight:600}@media (max-width: 768px){.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch;gap:.75rem}.debt-alert-content[_ngcontent-%COMP%]   .alert-header[_ngcontent-%COMP%]   .plate-info[_ngcontent-%COMP%]{justify-content:center}.debt-alert-content[_ngcontent-%COMP%]   .action-options[_ngcontent-%COMP%]{grid-template-columns:1fr}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.5rem}.debt-alert-content[_ngcontent-%COMP%]   .debts-list[_ngcontent-%COMP%]   .debt-item[_ngcontent-%COMP%]   .debt-info[_ngcontent-%COMP%]   .debt-details[_ngcontent-%COMP%]{flex-direction:column;gap:.25rem}}[_nghost-%COMP%]     .p-dialog-footer{padding:1rem 1.5rem;border-top:1px solid #e5e7eb;background-color:#f9fafb}"]})}}return a})();function Le(a,m){if(a&1&&(t(0,"mat-error"),o(1),n()),a&2){let e=p();s(),C(" ",e.getFieldError("plate")," ")}}function We(a,m){if(a&1&&(t(0,"mat-option",19),o(1),n()),a&2){let e=m.$implicit;l("value",e.id),s(),N(" ",e.name," ",e.is_private?"(Privado)":"(P\xFAblico)"," ")}}function qe(a,m){if(a&1&&(t(0,"mat-error"),o(1),n()),a&2){let e=p();s(),C(" ",e.getFieldError("sector_id")," ")}}function Ue(a,m){if(a&1&&(t(0,"mat-option",19),o(1),n()),a&2){let e=m.$implicit;l("value",e.id),s(),C(" ",e.name," ")}}function $e(a,m){if(a&1&&(t(0,"mat-error"),o(1),n()),a&2){let e=p();s(),C(" ",e.getFieldError("street_id")," ")}}function Ge(a,m){a&1&&(t(0,"mat-hint"),o(1,"Selecciona primero un sector"),n())}function He(a,m){a&1&&(t(0,"mat-hint"),o(1,"Este sector no tiene calles registradas"),n())}function Re(a,m){if(a&1&&(t(0,"mat-option",19),o(1),n()),a&2){let e=m.$implicit;l("value",e.id),s(),N(" ",e.name," - ",e.rut," ")}}function Ze(a,m){if(a&1&&(t(0,"mat-error"),o(1),n()),a&2){let e=p();s(),C(" ",e.getFieldError("operator_id")," ")}}function Ye(a,m){a&1&&(t(0,"mat-hint"),o(1,"Selecciona primero un sector y una calle"),n())}function Je(a,m){a&1&&(t(0,"mat-hint"),o(1,"No hay operadores disponibles para este sector y calle"),n())}function Ke(a,m){if(a&1&&(t(0,"div",34)(1,"mat-icon",35),o(2,"directions_car"),n(),t(3,"div")(4,"p",36),o(5,"Placa"),n(),t(6,"p",37),o(7),n()()()),a&2){let e=p(2);s(7),_(e.sessionForm.value.plate)}}function Qe(a,m){if(a&1&&(t(0,"div",34)(1,"mat-icon",35),o(2,"location_on"),n(),t(3,"div")(4,"p",36),o(5,"Sector"),n(),t(6,"p",37),o(7),n()()()),a&2){let e=p(2);s(7),_(e.getSectorName(e.sessionForm.value.sector_id))}}function Xe(a,m){if(a&1&&(t(0,"div",34)(1,"mat-icon",35),o(2,"place"),n(),t(3,"div")(4,"p",36),o(5,"Calle"),n(),t(6,"p",37),o(7),n()()()),a&2){let e=p(2);s(7),_(e.getStreetName(e.sessionForm.value.street_id))}}function et(a,m){if(a&1&&(t(0,"div",34)(1,"mat-icon",35),o(2,"person"),n(),t(3,"div")(4,"p",36),o(5,"Operador"),n(),t(6,"p",37),o(7),n()()()),a&2){let e=p(2);s(7),_(e.getOperatorName(e.sessionForm.value.operator_id))}}function tt(a,m){if(a&1&&(t(0,"div",34)(1,"mat-icon",35),o(2,"schedule"),n(),t(3,"div")(4,"p",36),o(5,"Tipo de Ingreso"),n(),t(6,"p",37),o(7),n()()()),a&2){let e=p(2);s(7),C(" ",e.sessionForm.value.is_full_day?"D\xEDa Completo":"Por Tiempo"," ")}}function nt(a,m){if(a&1&&(t(0,"fuse-card",31)(1,"div",27)(2,"h3",28),o(3,"Informaci\xF3n de la Sesi\xF3n"),n(),t(4,"div",32),u(5,Ke,8,1,"div",33)(6,Qe,8,1,"div",33)(7,Xe,8,1,"div",33)(8,et,8,1,"div",33)(9,tt,8,1,"div",33),n()()()),a&2){let e=p();s(5),l("ngIf",e.sessionForm.value.plate),s(),l("ngIf",e.sessionForm.value.sector_id),s(),l("ngIf",e.sessionForm.value.street_id),s(),l("ngIf",e.sessionForm.value.operator_id),s(),l("ngIf",e.sessionForm.value.is_full_day!==void 0)}}function it(a,m){if(a&1&&(t(0,"div",38)(1,"fuse-alert",39),o(2),n()()),a&2){let e=p();s(),l("dismissible",!0),s(),C(" ",e.error," ")}}function ot(a,m){a&1&&v(0,"mat-spinner",40)}function rt(a,m){a&1&&(t(0,"mat-icon"),o(1,"add"),n())}var Gt=(()=>{class a{constructor(e,r,i,d,c,M,g,O){this.fb=e,this.sessionService=r,this.sectorService=i,this.operatorService=d,this.debtService=c,this.printerService=M,this.router=g,this.snackBar=O,this._unsubscribeAll=new j,this.loading=!1,this.error=null,this.sectors=[],this.operators=[],this.streets=[],this.operatorAssignments=[],this.currentOperator=null,this.showDebtAlert=!1,this.pendingDebts=[],this.currentPlate="",this.sessionForm=this.createForm()}ngOnInit(){this.loadSectors(),this.loadOperators(),this.setupFormSubscriptions()}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}createForm(){return this.fb.group({plate:["",[P.required,P.pattern(/^[A-Z0-9]+$/i)]],sector_id:["",P.required],street_id:[null,P.required],operator_id:["",P.required],is_full_day:[!1]})}setupFormSubscriptions(){this.sessionForm.get("sector_id")?.valueChanges.pipe(f(this._unsubscribeAll)).subscribe(e=>{e?(this.sessionForm.patchValue({street_id:null,operator_id:""}),this.loadStreetsBySector(e)):(this.streets=[],this.operators=[],this.sessionForm.patchValue({street_id:null,operator_id:""}))}),this.sessionForm.get("street_id")?.valueChanges.pipe(f(this._unsubscribeAll)).subscribe(e=>{let r=this.sessionForm.value.sector_id;r&&e?this.filterOperatorsBySectorAndStreet(r,e):e||(this.operators=[]),this.sessionForm.patchValue({operator_id:""},{emitEvent:!1})})}loadSectors(){this.sectorService.getSectors().pipe(f(this._unsubscribeAll)).subscribe({next:e=>{this.sectors=e.data?.data||[]},error:e=>{console.error("Error loading sectors:",e),this.snackBar.open("Error al cargar sectores","Cerrar",{duration:3e3})}})}loadOperators(){this.operatorService.getOperators().pipe(f(this._unsubscribeAll)).subscribe({next:e=>{this.operators=e.data?.data||[]},error:e=>{console.error("Error loading operators:",e),this.snackBar.open("Error al cargar operadores","Cerrar",{duration:3e3})}})}loadStreetsBySector(e){if(!e){this.streets=[],console.log("No sector selected, clearing streets");return}console.log("Loading streets for sector:",e),this.sectorService.getSectorStreets(e).pipe(f(this._unsubscribeAll)).subscribe({next:r=>{this.streets=r.data||[],console.log("Streets loaded for sector",e,":",this.streets.length,"streets"),this.streets.length>0?(this.sessionForm.patchValue({street_id:this.streets[0].id}),console.log("Auto-selected first street:",this.streets[0].id)):this.sessionForm.patchValue({street_id:null})},error:r=>{console.error("Error loading streets:",r),this.streets=[],this.sessionForm.patchValue({street_id:null})}})}filterOperatorsBySector(e){if(!e){this.operators=[];return}this.operatorService.getOperators().pipe(f(this._unsubscribeAll)).subscribe({next:r=>{this.operators=(r.data?.data||[]).filter(i=>i.sectors?.some(d=>d.id===e&&this.isAssignmentValid(d.pivot)))},error:r=>{console.error("Error filtering operators:",r),this.operators=[]}})}filterOperatorsBySectorAndStreet(e,r){if(!e){this.operators=[];return}console.log("Filtrando operadores para sector:",e,"calle:",r),this.operatorService.getOperators().pipe(f(this._unsubscribeAll)).subscribe({next:i=>{let d=i.data?.data||[];console.log("Todos los operadores cargados:",d.length),this.operators=d.filter(c=>{let M=c.operator_assignments?.some(g=>{if(g.sector_id===e){let O=new Date,Te=new Date(g.valid_from),V=g.valid_to?new Date(g.valid_to):null,z=Te<=O&&(!V||V>=O),T=!0;return r&&(T=!g.street_id||g.street_id===r),console.log("Operador:",c.name,"Sector match:",g.sector_id===e,"Street access:",T,"Date valid:",z,"Assignment:",g),z&&T}return!1});return console.log("Operador:",c.name,"Has valid assignment:",M),M}),console.log("Operadores filtrados:",this.operators.length)},error:i=>{console.error("Error filtering operators:",i),this.operators=[]}})}isAssignmentValid(e){let r=new Date,i=new Date(e.valid_from),d=e.valid_to?new Date(e.valid_to):null;return i<=r&&(!d||d>=r)}onSubmit(){if(this.sessionForm.invalid){this.markFormGroupTouched();return}let e=this.sessionForm.value.plate.toUpperCase();if(!this.sessionService.validateChileanPlate(e)){this.snackBar.open("Formato de patente inv\xE1lido","Cerrar",{duration:3e3});return}this.checkPendingDebts(e)}checkPendingDebts(e){this.loading=!0,this.error=null,this.debtService.getDebtsByPlate(e).pipe(f(this._unsubscribeAll)).subscribe({next:r=>{let d=(r.data||[]).filter(c=>c.status==="PENDING");d.length>0?(this.pendingDebts=d,this.currentPlate=e,this.showDebtAlert=!0,this.loading=!1):this.createSession(e)},error:r=>{console.error("Error checking debts:",r),this.createSession(e)}})}createSession(e){this.loading=!0,this.error=null;let r=this.sessionForm.value.street_id,i=r&&r!==""?r:null,d={plate:e,sector_id:this.sessionForm.value.sector_id,street_id:i,operator_id:this.sessionForm.value.operator_id,is_full_day:this.sessionForm.value.is_full_day||!1};this.sessionService.createSession(d).pipe(f(this._unsubscribeAll)).subscribe({next:c=>{this.snackBar.open("Sesi\xF3n creada exitosamente","Cerrar",{duration:3e3}),this.printEntryTicket(c.data),this.router.navigate(["/parking/sessions",c.data.id])},error:c=>{this.error=c.error?.message||"Error al crear sesi\xF3n",this.loading=!1,console.error("Error creating session:",c),c.error?.error_code==="NO_SHIFT_OPEN"?(this.snackBar.open("No hay turno abierto para este operador. Abre un turno antes de crear sesiones.","Cerrar",{duration:7e3}),this.router.navigate(["/parking/shifts"])):this.snackBar.open(this.error,"Cerrar",{duration:5e3})}})}onPayDebts(){this.router.navigate(["/parking/debts"],{queryParams:{plate:this.currentPlate,filter:"PENDING"}})}onContinueWithoutPayment(){this.createSession(this.currentPlate)}closeDebtAlert(){this.showDebtAlert=!1,this.pendingDebts=[],this.currentPlate="",this.loading=!1}markFormGroupTouched(){Object.keys(this.sessionForm.controls).forEach(e=>{this.sessionForm.get(e)?.markAsTouched()})}onCancel(){this.router.navigate(["/parking/sessions"])}getFieldError(e){let r=this.sessionForm.get(e);if(r?.errors&&r.touched){if(r.errors.required)return`${this.getFieldLabel(e)} es requerido`;if(r.errors.pattern)return`${this.getFieldLabel(e)} tiene un formato inv\xE1lido`}return""}getFieldLabel(e){return{plate:"Placa",sector_id:"Sector",street_id:"Calle",operator_id:"Operador"}[e]||e}isFieldInvalid(e){let r=this.sessionForm.get(e);return!!(r?.invalid&&r.touched)}formatPlate(e){let i=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"");this.sessionForm.patchValue({plate:i})}getSectorName(e){let r=this.sectors.find(i=>i.id===e);return r?r.name:""}getStreetName(e){let r=this.streets.find(i=>i.id===e);return r?r.name:""}getOperatorName(e){let r=this.operators.find(i=>i.id===e);return r?r.name:""}hasStreets(){return this.streets.length>0}hasOperators(){return this.operators.length>0}printEntryTicket(e){this.printerService.printEntryTicket(e).pipe(f(this._unsubscribeAll)).subscribe({next:r=>{r.printed?this.snackBar.open("Ticket de entrada impreso exitosamente","Cerrar",{duration:3e3}):this.snackBar.open(r.message,"Cerrar",{duration:5e3})},error:r=>{console.error("Error printing entry ticket:",r),this.snackBar.open("Error al imprimir ticket de entrada","Cerrar",{duration:3e3})}})}static{this.\u0275fac=function(r){return new(r||a)(h(de),h(Ee),h(we),h(De),h(ye),h(Ie),h(G),h(fe))}}static{this.\u0275cmp=y({type:a,selectors:[["app-new-session"]],decls:98,vars:30,consts:[[1,"p-6","mx-auto"],[1,"mb-8"],[1,"flex","items-center","justify-between"],[1,"text-3xl","font-bold","text-gray-900"],[1,"mt-2","text-gray-600"],["mat-button","",1,"rounded-sm",3,"click"],[1,"max-w-2xl","mx-auto"],[1,"p-6"],["novalidate","",3,"ngSubmit","formGroup"],["appearance","outline",1,"w-full","mb-4"],["matInput","","formControlName","plate","placeholder","ABC123","maxlength","10","autocomplete","off",3,"input"],["matPrefix",""],[4,"ngIf"],["formControlName","sector_id"],[3,"value",4,"ngFor","ngForOf"],["formControlName","street_id",3,"disabled"],["formControlName","operator_id",3,"disabled"],["appearance","outline",1,"w-full","mb-6"],["formControlName","is_full_day"],[3,"value"],["class","mb-6",4,"ngIf"],["class","mb-4",4,"ngIf"],[1,"flex","items-center","justify-end","gap-4"],["type","button","mat-button","",3,"click","disabled"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],[1,"mt-6"],[1,"p-4"],[1,"text-lg","font-medium","text-gray-900","mb-3"],[1,"space-y-2","text-sm","text-gray-600"],[3,"visibleChange","payDebts","continueWithoutPayment","visible","debts","plate"],[1,"mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],["class","flex items-center",4,"ngIf"],[1,"flex","items-center"],[1,"text-gray-500","mr-2"],[1,"text-sm","text-gray-600"],[1,"font-medium","text-gray-900"],[1,"mb-4"],["type","error",3,"dismissible"],["diameter","20",1,"mr-2"]],template:function(r,i){r&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"div")(4,"h1",3),o(5,"Nueva Sesi\xF3n de Estacionamiento"),n(),t(6,"p",4),o(7,"Crear una nueva sesi\xF3n de estacionamiento"),n()(),t(8,"button",5),b("click",function(){return i.onCancel()}),t(9,"mat-icon"),o(10,"arrow_back"),n(),o(11," Volver a Sesiones "),n()()(),t(12,"div",6)(13,"fuse-card")(14,"div",7)(15,"form",8),b("ngSubmit",function(){return i.onSubmit()}),t(16,"mat-form-field",9)(17,"mat-label"),o(18,"Placa del Veh\xEDculo"),n(),t(19,"input",10),b("input",function(c){return i.formatPlate(c)}),n(),t(20,"mat-icon",11),o(21,"directions_car"),n(),t(22,"mat-hint"),o(23,"Formato: ABC123, 1234AB, ABCD12"),n(),u(24,Le,2,1,"mat-error",12),n(),t(25,"mat-form-field",9)(26,"mat-label"),o(27,"Sector"),n(),t(28,"mat-select",13),u(29,We,2,3,"mat-option",14),n(),t(30,"mat-icon",11),o(31,"location_on"),n(),u(32,qe,2,1,"mat-error",12),n(),t(33,"mat-form-field",9)(34,"mat-label"),o(35,"Calle *"),n(),t(36,"mat-select",15),u(37,Ue,2,2,"mat-option",14),n(),t(38,"mat-icon",11),o(39,"place"),n(),u(40,$e,2,1,"mat-error",12)(41,Ge,2,0,"mat-hint",12)(42,He,2,0,"mat-hint",12),n(),t(43,"mat-form-field",9)(44,"mat-label"),o(45,"Operador"),n(),t(46,"mat-select",16),u(47,Re,2,3,"mat-option",14),n(),t(48,"mat-icon",11),o(49,"person"),n(),u(50,Ze,2,1,"mat-error",12)(51,Ye,2,0,"mat-hint",12)(52,Je,2,0,"mat-hint",12),n(),t(53,"mat-form-field",17)(54,"mat-label"),o(55,"Tipo de Ingreso"),n(),t(56,"mat-select",18)(57,"mat-option",19),o(58," Por Tiempo "),n(),t(59,"mat-option",19),o(60," D\xEDa Completo "),n()(),t(61,"mat-icon",11),o(62,"schedule"),n(),t(63,"mat-hint"),o(64,"Selecciona si el ingreso es por tiempo o por d\xEDa completo"),n()(),u(65,nt,10,5,"fuse-card",20)(66,it,3,2,"div",21),t(67,"div",22)(68,"button",23),b("click",function(){return i.onCancel()}),o(69," Cancelar "),n(),t(70,"button",24),u(71,ot,1,0,"mat-spinner",25)(72,rt,2,0,"mat-icon",12),o(73),n()()()()(),t(74,"fuse-card",26)(75,"div",27)(76,"h3",28),o(77,"Informaci\xF3n Importante"),n(),t(78,"div",29)(79,"p"),o(80,"\u2022 La placa debe tener un formato v\xE1lido chileno (ABC123, 1234AB, ABCD12)"),n(),t(81,"p"),o(82,"\u2022 Solo se pueden crear sesiones en sectores donde el operador tenga acceso"),n(),t(83,"p"),o(84,"\u2022 Una vez creada la sesi\xF3n, el veh\xEDculo estar\xE1 registrado como estacionado"),n(),t(85,"p"),o(86,"\u2022 El sistema validar\xE1 autom\xE1ticamente que no exista otra sesi\xF3n activa para la misma placa en el sector"),n(),t(87,"p"),o(88,"\u2022 "),t(89,"strong"),o(90,"Por Tiempo:"),n(),o(91," El cobro se calcula seg\xFAn la duraci\xF3n real del estacionamiento"),n(),t(92,"p"),o(93,"\u2022 "),t(94,"strong"),o(95,"D\xEDa Completo:"),n(),o(96," Se cobra la tarifa m\xE1xima diaria del perfil de precios, independientemente del tiempo. El veh\xEDculo permanece ocupando el espacio hasta el checkout"),n()()()()(),t(97,"app-debt-alert-modal",30),D("visibleChange",function(c){return w(i.showDebtAlert,c)||(i.showDebtAlert=c),c}),b("payDebts",function(){return i.onPayDebts()})("continueWithoutPayment",function(){return i.onContinueWithoutPayment()})("visibleChange",function(){return i.closeDebtAlert()}),n()()),r&2&&(s(15),l("formGroup",i.sessionForm),s(9),l("ngIf",i.isFieldInvalid("plate")),s(5),l("ngForOf",i.sectors),s(3),l("ngIf",i.isFieldInvalid("sector_id")),s(),k("mat-form-field-disabled",!i.hasStreets()),s(3),l("disabled",!i.sessionForm.value.sector_id),s(),l("ngForOf",i.streets),s(3),l("ngIf",i.isFieldInvalid("street_id")),s(),l("ngIf",!i.sessionForm.value.sector_id),s(),l("ngIf",i.sessionForm.value.sector_id&&!i.hasStreets()),s(),k("mat-form-field-disabled",!i.hasOperators()),s(3),l("disabled",!i.hasOperators()||!i.sessionForm.value.sector_id||!i.sessionForm.value.street_id),s(),l("ngForOf",i.operators),s(3),l("ngIf",i.isFieldInvalid("operator_id")),s(),l("ngIf",!i.sessionForm.value.sector_id),s(),l("ngIf",i.sessionForm.value.sector_id&&i.sessionForm.value.street_id&&!i.hasOperators()),s(5),l("value",!1),s(2),l("value",!0),s(6),l("ngIf",i.sessionForm.value.sector_id||i.sessionForm.value.operator_id),s(),l("ngIf",i.error),s(2),l("disabled",i.loading),s(2),l("disabled",i.loading||i.sessionForm.invalid||!i.hasOperators()),s(),l("ngIf",i.loading),s(),l("ngIf",!i.loading),s(),C(" ",i.loading?"Creando...":"Crear Sesi\xF3n"," "),s(24),F("visible",i.showDebtAlert),l("debts",i.pendingDebts)("plate",i.currentPlate))},dependencies:[A,I,$,me,ae,ie,oe,re,ce,se,le,ee,X,ne,te,Q,K,R,Y,Z,J,ue,pe,xe,Se,H,Fe,_e,ge,be,Oe,Ae],styles:[".form-container[_ngcontent-%COMP%]{max-width:600px;margin:0 auto}.info-card[_ngcontent-%COMP%]{background-color:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]{display:flex;align-items:center;padding:.5rem 0}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#6b7280;margin-right:.75rem}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]   .info-label[_ngcontent-%COMP%]{font-size:.875rem;color:#6b7280;margin-bottom:.25rem}.info-card[_ngcontent-%COMP%]   .info-item[_ngcontent-%COMP%]   .info-value[_ngcontent-%COMP%]{font-weight:500;color:#111827}.help-card[_ngcontent-%COMP%]{background-color:#f0f9ff;border:1px solid #bae6fd;border-radius:8px}.help-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#0c4a6e}.help-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#075985}.mat-form-field[_ngcontent-%COMP%]{width:100%}.action-buttons[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:1rem;margin-top:2rem}.loading-button[_ngcontent-%COMP%]{display:flex;align-items:center}.loading-button[_ngcontent-%COMP%]   mat-spinner[_ngcontent-%COMP%]{margin-right:.5rem}@media (max-width: 768px){.form-container[_ngcontent-%COMP%]{max-width:100%;padding:0 1rem}.action-buttons[_ngcontent-%COMP%]{flex-direction:column-reverse}.action-buttons[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}.error-alert[_ngcontent-%COMP%]{margin-bottom:1rem}.success-message[_ngcontent-%COMP%]{background-color:#f0fdf4;border:1px solid #bbf7d0;color:#166534;padding:1rem;border-radius:8px;margin-bottom:1rem}"]})}}return a})();export{Gt as NewSessionComponent};
