import{a as ne}from"./chunk-7TD3HKIE.js";import{a as te,b as oe}from"./chunk-ASZQIH2H.js";import{a as Z,b as ee}from"./chunk-FSRW5HPF.js";import{a as I,b as A}from"./chunk-65NYBKEE.js";import{b as O,c as B}from"./chunk-IMRKXFOQ.js";import{d as K,e as W}from"./chunk-TWB6D3BU.js";import{a as X,b as Y}from"./chunk-CWSZZ2DY.js";import{b as q,c as P,e as w,j as T,k as N}from"./chunk-K3BNOLHS.js";import{b as H,d as _,f as R,g as z,k as G,l as Q,n as L,o as U,v as $,y as J}from"./chunk-AWW653NS.js";import{fa as F,la as D,na as V,oa as j}from"./chunk-QQQ5XT6I.js";import{m as k,s as E}from"./chunk-BAM5RHC5.js";import{$b as p,Eb as s,Pb as o,Qb as n,Rb as x,U as b,bb as m,bc as f,cb as c,f as M,mc as i,nc as g,oc as v,pb as S,wb as d}from"./chunk-MLNNMN4J.js";function ie(a,u){a&1&&(o(0,"mat-error"),i(1," El m\xE9todo de pago es requerido "),n())}function re(a,u){a&1&&(o(0,"mat-error"),i(1," El monto es requerido "),n())}function ae(a,u){a&1&&(o(0,"mat-error"),i(1," El monto debe ser mayor a 0 "),n())}function me(a,u){if(a&1&&(o(0,"div",29)(1,"div",30)(2,"div",31)(3,"mat-icon",32),i(4,"monetization_on"),n(),o(5,"span",33),i(6,"Vuelto a entregar:"),n()(),o(7,"span",34),i(8),n()()()),a&2){let e=f(2);m(8),g(e.formatAmount(e.calculateChange()))}}function le(a,u){if(a&1&&(o(0,"div",35)(1,"div",30)(2,"div",31)(3,"mat-icon",36),i(4,"warning"),n(),o(5,"span",37),i(6,"Monto faltante:"),n()(),o(7,"span",38),i(8),n()()()),a&2){let e=f(2);m(8),g(e.formatAmount(e.calculateAmountMissing()))}}function se(a,u){if(a&1&&(o(0,"div",26),d(1,me,9,1,"div",27)(2,le,9,1,"div",28),n()),a&2){let e=f();m(),s("ngIf",e.shouldShowChange()),m(),s("ngIf",e.shouldShowMissingAmount())}}function ue(a,u){a&1&&x(0,"mat-spinner",39)}function ce(a,u){a&1&&(o(0,"mat-icon"),i(1,"payment"),n())}var Ve=(()=>{class a{constructor(e,t,r,l,h){this.dialogRef=e,this.data=t,this.fb=r,this.sessionService=l,this.snackBar=h,this._unsubscribeAll=new M,this.quote=null,this.processing=!1,this.session=t.session,this.quote=t.quote,this.checkoutForm=this.createForm()}ngOnInit(){this.quote?this.initializeForm():this.loadQuote()}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}createForm(){return this.fb.group({payment_method:["CASH",_.required],amount:["",[_.required,_.min(0)]],notes:[""]})}initializeForm(){this.quote&&(this.checkoutForm.get("payment_method")?.value==="CASH"?this.checkoutForm.patchValue({amount:""}):this.checkoutForm.patchValue({amount:this.quote.net_amount}))}loadQuote(){if(!this.session)return;let e=new Date().toISOString();this.sessionService.getQuote(this.session.id,{ended_at:e}).pipe(b(this._unsubscribeAll)).subscribe({next:t=>{this.quote=t.data,this.initializeForm()},error:t=>{console.error("Error loading quote:",t),this.snackBar.open("Error al cargar la cotizaci\xF3n","Cerrar",{duration:3e3})}})}onPaymentMethodChange(){this.checkoutForm.get("payment_method")?.value==="CASH"?this.checkoutForm.patchValue({amount:""}):this.checkoutForm.patchValue({amount:this.quote?.net_amount||0})}isAmountFieldDisabled(){return this.checkoutForm.get("payment_method")?.value!=="CASH"}shouldShowChange(){let e=this.checkoutForm.get("payment_method")?.value,t=this.checkoutForm.get("amount")?.value,r=t===""||t===null||t===void 0?0:typeof t=="string"?parseFloat(t)||0:Number(t)||0;return e==="CASH"&&r>(this.quote?.net_amount||0)}shouldShowMissingAmount(){let e=this.checkoutForm.get("payment_method")?.value,t=this.checkoutForm.get("amount")?.value,r=t===""||t===null||t===void 0?0:typeof t=="string"?parseFloat(t)||0:Number(t)||0;return e==="CASH"&&r<(this.quote?.net_amount||0)}calculateChange(){let e=this.checkoutForm.get("amount")?.value;return(e===""||e===null||e===void 0?0:typeof e=="string"?parseFloat(e)||0:Number(e)||0)-(this.quote?.net_amount||0)}calculateAmountMissing(){let e=this.checkoutForm.get("amount")?.value,t=e===""||e===null||e===void 0?0:typeof e=="string"?parseFloat(e)||0:Number(e)||0;return(this.quote?.net_amount||0)-t}formatAmount(e){return this.sessionService.formatAmount(e)}onSubmit(){if(this.checkoutForm.invalid||!this.quote)return;this.processing=!0;let e=this.checkoutForm.value,t=0;e.amount!==""&&e.amount!==null&&e.amount!==void 0&&(t=typeof e.amount=="string"?parseFloat(e.amount)||0:Number(e.amount)||0);let r={amount:t,payment_method:e.payment_method,notes:e.notes||null,operator_id:this.session.operator_in_id};this.sessionService.checkoutSession(this.session.id,r).pipe(b(this._unsubscribeAll)).subscribe({next:l=>{this.processing=!1,this.snackBar.open("Pago procesado exitosamente","Cerrar",{duration:3e3}),this.dialogRef.close({success:!0,data:l.data})},error:l=>{this.processing=!1,console.error("Error processing payment:",l),this.snackBar.open("Error al procesar el pago","Cerrar",{duration:3e3})}})}onClose(){this.dialogRef.close({success:!1})}static{this.\u0275fac=function(t){return new(t||a)(c(I),c(A),c($),c(ne),c(Z))}}static{this.\u0275cmp=S({type:a,selectors:[["app-checkout-modal"]],decls:54,vars:12,consts:[[1,"checkout-modal"],[1,"flex","items-center","justify-between","p-6","border-b","border-gray-200","bg-gray-50","rounded-t-lg"],[1,"flex","items-center","gap-3"],[1,"text-blue-600"],[1,"text-xl","font-semibold","text-gray-900"],[1,"text-sm","text-gray-600"],["mat-icon-button","",1,"text-gray-500","hover:text-gray-700",3,"click"],[1,"p-6"],[1,"bg-primary-50","border","border-primary-200","rounded-lg","p-6","mb-6","text-center"],[1,"text-lg","font-semibold","text-primary-700","mb-2"],[1,"text-4xl","font-bold","text-primary-900"],[1,"space-y-6",3,"ngSubmit","formGroup"],["appearance","outline",1,"w-full"],["formControlName","payment_method",3,"selectionChange"],["value","CASH"],["value","CARD"],["value","TRANSFER"],[4,"ngIf"],["matInput","","type","number","formControlName","amount","placeholder","0",3,"readonly"],["matPrefix",""],["class","space-y-3",4,"ngIf"],["matInput","","formControlName","notes","rows","3","placeholder","Observaciones adicionales..."],[1,"flex","flex-col","sm:flex-row","gap-3","justify-end","pt-4"],["type","button","mat-stroked-button","",1,"rounded-sm",3,"click"],["type","submit","mat-raised-button","","color","primary",1,"rounded-sm",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],[1,"space-y-3"],["class","bg-green-50 border border-green-200 rounded-lg p-4",4,"ngIf"],["class","bg-red-50 border border-red-200 rounded-lg p-4",4,"ngIf"],[1,"bg-green-50","border","border-green-200","rounded-lg","p-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],[1,"text-green-600"],[1,"text-green-800","font-semibold"],[1,"text-xl","font-bold","text-green-700"],[1,"bg-red-50","border","border-red-200","rounded-lg","p-4"],[1,"text-red-600"],[1,"text-red-800","font-semibold"],[1,"text-xl","font-bold","text-red-700"],["diameter","20",1,"mr-2"]],template:function(t,r){if(t&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"mat-icon",3),i(4,"payment"),n(),o(5,"div")(6,"h2",4),i(7," Procesar Pago "),n(),o(8,"p",5),i(9),n()()(),o(10,"button",6),p("click",function(){return r.onClose()}),o(11,"mat-icon"),i(12,"close"),n()()(),o(13,"div",7)(14,"div",8)(15,"h3",9),i(16,"Total a Pagar"),n(),o(17,"p",10),i(18),n()(),o(19,"form",11),p("ngSubmit",function(){return r.onSubmit()}),o(20,"mat-form-field",12)(21,"mat-label"),i(22,"M\xE9todo de Pago"),n(),o(23,"mat-select",13),p("selectionChange",function(){return r.onPaymentMethodChange()}),o(24,"mat-option",14),i(25,"Efectivo"),n(),o(26,"mat-option",15),i(27,"Tarjeta"),n(),o(28,"mat-option",16),i(29,"Transferencia"),n()(),d(30,ie,2,0,"mat-error",17),n(),o(31,"mat-form-field",12)(32,"mat-label"),i(33,"Monto Pagado"),n(),x(34,"input",18),o(35,"span",19),i(36,"$\xA0"),n(),d(37,re,2,0,"mat-error",17)(38,ae,2,0,"mat-error",17),n(),d(39,se,3,2,"div",20),o(40,"mat-form-field",12)(41,"mat-label"),i(42,"Notas (opcional)"),n(),o(43,"textarea",21),i(44,"        "),n()(),o(45,"div",22)(46,"button",23),p("click",function(){return r.onClose()}),o(47,"mat-icon"),i(48,"close"),n(),i(49," Cancelar "),n(),o(50,"button",24),d(51,ue,1,0,"mat-spinner",25)(52,ce,2,0,"mat-icon",17),i(53),n()()()()()),t&2){let l,h,C,y;m(9),v("Placa: ",r.session.plate,""),m(9),g(r.formatAmount(r.quote.net_amount)),m(),s("formGroup",r.checkoutForm),m(11),s("ngIf",(l=r.checkoutForm.get("payment_method"))==null?null:l.hasError("required")),m(4),s("readonly",r.isAmountFieldDisabled()),m(3),s("ngIf",(h=r.checkoutForm.get("amount"))==null?null:h.hasError("required")),m(),s("ngIf",(C=r.checkoutForm.get("amount"))==null?null:C.hasError("min")),m(),s("ngIf",((y=r.checkoutForm.get("payment_method"))==null?null:y.value)==="CASH"),m(11),s("disabled",r.checkoutForm.invalid||r.processing),m(),s("ngIf",r.processing),m(),s("ngIf",!r.processing),m(),v(" ",r.processing?"Procesando...":"Confirmar Pago"," ")}},dependencies:[E,k,J,G,H,Q,R,z,L,U,j,D,V,B,O,N,T,q,P,w,W,K,oe,te,F,Y,X,ee],styles:[".checkout-modal[_ngcontent-%COMP%]{width:100%;max-width:500px;margin:0 auto}.mat-mdc-form-field[_ngcontent-%COMP%]{width:100%}.mat-mdc-button[_ngcontent-%COMP%]{border-radius:4px!important}.mat-mdc-progress-spinner[_ngcontent-%COMP%]{margin-right:8px}@media (max-width: 640px){.checkout-modal[_ngcontent-%COMP%]{max-width:95vw}}"]})}}return a})();export{Ve as a};
