import{a as m}from"./chunk-VKB6BRO6.js";import{d as v}from"./chunk-FFRRSTTN.js";import{d as l}from"./chunk-EARUC3FY.js";import{B as b,W as i,_ as c,da as u,ea as p,g as a,l as S,p as h}from"./chunk-MLNNMN4J.js";import{a as s}from"./chunk-TSRGIXR5.js";var C=(()=>{class r{constructor(){this._httpClient=p(l),this._systemConfig=new a({name:"STPark - Sistema de Gesti\xF3n de Estacionamientos",currency:"CLP",timezone:"America/Santiago",language:"es",pos_tuu:!1,max_capacity:0}),this._configLoaded=!1}loadConfig(){let e={name:"STPark - Sistema de Gesti\xF3n de Estacionamientos",currency:"CLP",timezone:"America/Santiago",language:"es",pos_tuu:!1,max_capacity:0};return this._httpClient.get(`${m.apiUrl}/settings/general`).pipe(h(t=>{if(t&&t.success&&t.data){let n=s(s({},e),t.data);return(!n.name||n.name.trim()==="")&&(console.warn("ConfigService: El nombre del sistema est\xE1 vac\xEDo, usando valor por defecto"),n.name=e.name),n}return console.warn("ConfigService: La respuesta no tiene el formato esperado:",t),e}),i(t=>{this._systemConfig.next(t),this._configLoaded=!0,console.log("Configuraci\xF3n del sistema cargada:",t)}),b(t=>(console.error("Error al cargar configuraci\xF3n del sistema:",t),this._systemConfig.next(e),S(e))))}refreshConfig(){this.loadConfig().subscribe()}isConfigLoaded(){return this._configLoaded}get systemConfig$(){return this._systemConfig.asObservable()}getSystemConfig(){return this._systemConfig.value}getSystemName(){return this._systemConfig.value.name}getSystemName$(){return this._systemConfig.asObservable().pipe(h(e=>e.name))}getCurrency(){return this._systemConfig.value.currency}getTimezone(){return this._systemConfig.value.timezone}getLanguage(){return this._systemConfig.value.language}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var E=(()=>{class r{constructor(e,t,n){this.http=e,this.router=t,this.configService=n,this.baseUrl=`${m.authApiUrl}/api/auth`,this.currentUserSubject=new a(null),this.tokenSubject=new a(null),this.tenantsSubject=new a([]),this.currentTenantSubject=new a(null),this.currentUser$=this.currentUserSubject.asObservable(),this.token$=this.tokenSubject.asObservable(),this.tenants$=this.tenantsSubject.asObservable(),this.currentTenant$=this.currentTenantSubject.asObservable(),this.loadStoredAuth()}login(e){return this.http.post(`${this.baseUrl}/login`,e).pipe(i(t=>{console.log("Login response:",t),t.success&&(console.log("Setting auth for user:",t.data.user),console.log("Tenants received:",t.data.tenants),this.setAuth(t.data.user,t.data.token,t.data.tenants),console.log("Auth set successfully. Current tenant:",this.getCurrentTenant()),this.loadSystemConfig())}))}loadSystemConfig(){this.configService.loadConfig().subscribe({next:e=>{console.log("Configuraci\xF3n del sistema cargada exitosamente:",e)},error:e=>{console.error("Error al cargar configuraci\xF3n del sistema:",e)}})}logout(){console.log("Logging out..."),this.clearAuth(),localStorage.removeItem("accessToken"),console.log("Auth data cleared"),this.router.navigate(["/sign-in"])}isAuthenticated(){return!!this.tokenSubject.value}getCurrentUser(){return this.currentUserSubject.value}updateCurrentUser(e){let t=this.currentUserSubject.value;if(t){let n=s(s({},t),e);this.currentUserSubject.next(n),localStorage.setItem("current_user",JSON.stringify(n))}}getToken(){return this.tokenSubject.value}hasRole(e){return this.getCurrentUser()?.role===e}hasAnyRole(e){let t=this.getCurrentUser();return t?e.includes(t.role):!1}isCentralAdmin(){let e=this.getCurrentUser();return!e||e.is_central_admin===void 0||e.is_central_admin===null?!1:e.is_central_admin===!0||e.is_central_admin===1}getTenants(){return this.tenantsSubject.value}getCurrentTenant(){return this.currentTenantSubject.value}setCurrentTenant(e){this.currentTenantSubject.next(e),e?(localStorage.setItem("current_tenant",JSON.stringify(e)),localStorage.removeItem("central_admin_mode")):localStorage.removeItem("current_tenant")}setCentralAdminMode(){this.currentTenantSubject.next(null),localStorage.removeItem("current_tenant"),localStorage.setItem("central_admin_mode","true")}isCentralAdminMode(){return localStorage.getItem("central_admin_mode")==="true"}setAuth(e,t,n){console.log("setAuth called with:",{user:e,tenants:n}),this.currentUserSubject.next(e),this.tokenSubject.next(t),this.tenantsSubject.next(n);let o=this.isCentralAdminMode();n&&n.length>0&&!o?(console.log("Setting first tenant:",n[0]),this.setCurrentTenant(n[0])):o&&this.currentTenantSubject.next(null),localStorage.setItem("auth_token",t),localStorage.setItem("current_user",JSON.stringify(e)),localStorage.setItem("tenants",JSON.stringify(n)),console.log("Current tenant after setAuth:",this.getCurrentTenant())}clearAuth(){this.currentUserSubject.next(null),this.tokenSubject.next(null),this.tenantsSubject.next([]),this.currentTenantSubject.next(null),localStorage.removeItem("auth_token"),localStorage.removeItem("current_user"),localStorage.removeItem("tenants"),localStorage.removeItem("current_tenant"),localStorage.removeItem("central_admin_mode")}loadStoredAuth(){localStorage.getItem("accessToken")&&(console.log("Clearing old accessToken from previous auth system"),localStorage.removeItem("accessToken"));let t=localStorage.getItem("auth_token"),n=localStorage.getItem("current_user"),o=localStorage.getItem("tenants"),d=localStorage.getItem("current_tenant"),f=localStorage.getItem("central_admin_mode")==="true";if(console.log("Loading stored auth data:",{hasToken:!!t,hasUser:!!n,centralAdminMode:f}),t&&n)try{let g=JSON.parse(n);if(this.tokenSubject.next(t),this.currentUserSubject.next(g),o){let _=JSON.parse(o);this.tenantsSubject.next(_),f?this.currentTenantSubject.next(null):d&&this.currentTenantSubject.next(JSON.parse(d))}console.log("Stored auth data loaded successfully")}catch(g){console.error("Error parsing stored user:",g),this.clearAuth()}else console.log("No stored auth data found")}canManageSessions(){return this.hasAnyRole(["admin","operator","supervisor"])}canManagePayments(){return this.hasAnyRole(["admin","cashier","supervisor"])}canManageDebts(){return this.hasAnyRole(["admin","supervisor"])}canManageSectors(){return this.hasAnyRole(["admin","supervisor"])}canManageOperators(){return this.hasAnyRole(["admin","supervisor"])}canViewReports(){return this.hasAnyRole(["admin","supervisor","manager"])}canManageSettings(){return this.hasRole("admin")}static{this.\u0275fac=function(t){return new(t||r)(u(l),u(v),u(C))}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{E as a};
