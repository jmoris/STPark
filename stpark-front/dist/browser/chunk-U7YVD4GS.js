import{a as _t}from"./chunk-DW5H5A6R.js";import{a as W}from"./chunk-Q4BJS35R.js";import{a as ft}from"./chunk-VWULJZWU.js";import{a as ct,c as pt}from"./chunk-ZMAIZYCZ.js";import{a as ot,b as lt,c as mt,d as G,e as st,f as dt,g as ut}from"./chunk-FJTAFRYA.js";import{a as Ye,b as Ze,c as Je,d as Ke,e as Xe,f as et,g as tt,h as nt,i as it,j as at,k as rt}from"./chunk-A3W56N53.js";import{a as Ge,c as We,f as Qe}from"./chunk-CFZHHQ3I.js";import{a as Ce}from"./chunk-S5KA2L5P.js";import{a as $,b as He}from"./chunk-FGUURFJS.js";import{a as Ie,b as ke,c as De,d as we}from"./chunk-UQSNXR2K.js";import{a as Fe,b as Me}from"./chunk-3FSFXLFF.js";import{a as Oe,b as U}from"./chunk-MB5OSV7M.js";import"./chunk-AGGAQN5G.js";import{a as ue,b as fe,c as _e,e as ge,f as he,g as xe,h as D}from"./chunk-ZMKJJYLL.js";import"./chunk-EOYQYJ3N.js";import{a as ye}from"./chunk-GR6QKKXV.js";import{a as Te}from"./chunk-HEPNT2DL.js";import"./chunk-VKB6BRO6.js";import{a as $e,b as Ue}from"./chunk-GVLOHDYR.js";import{b as z,c as q}from"./chunk-72F6PA3H.js";import{d as R,e as L}from"./chunk-ZU6VUINT.js";import{b as w,c as Ee,d as Se,e as be,j as N,k as P}from"./chunk-EO526QJS.js";import{a as H,b as O}from"./chunk-6JXRNXI3.js";import{A as Le,b as V,d as _,f as j,g as Ne,j as Pe,k as Ae,l as Be,n as ze,q as qe,u as Ve,x as je,z as Re}from"./chunk-SGTC2IXF.js";import{fa as pe,la as A,na as ve,oa as B}from"./chunk-56JILNRZ.js";import"./chunk-TTG7A5I5.js";import"./chunk-P2DCSIJY.js";import"./chunk-FDUGCV2L.js";import{l as ce,m as I,t as k}from"./chunk-IZAOXH6X.js";import{$b as E,Eb as s,Ib as ne,Pb as n,Qb as t,Rb as p,Sb as b,Tb as v,U as F,Vb as Q,bb as l,bc as g,cb as h,f as te,fc as ie,gc as ae,hc as re,lc as oe,mc as i,nc as C,oa as T,oc as S,pa as y,pb as M,rc as le,sc as me,tc as se,uc as de,wb as c}from"./chunk-QDWFRTQW.js";import{a as ee}from"./chunk-TSRGIXR5.js";function Mt(a,m){a&1&&(n(0,"mat-error"),i(1," El ID es requerido "),t())}function It(a,m){a&1&&(n(0,"mat-error"),i(1," Solo se permiten letras min\xFAsculas, n\xFAmeros, guiones y guiones bajos "),t())}function kt(a,m){a&1&&(n(0,"mat-error"),i(1," Debe tener al menos 2 caracteres "),t())}function Dt(a,m){a&1&&(n(0,"mat-error"),i(1," El nombre es requerido "),t())}function wt(a,m){a&1&&(n(0,"mat-error"),i(1," Debe tener al menos 2 caracteres "),t())}function Nt(a,m){if(a&1&&(n(0,"span",27),i(1),t()),a&2){let e=g().$implicit;l(),S(" - ",e.description," ")}}function Pt(a,m){if(a&1&&(n(0,"mat-option",25),i(1),c(2,Nt,2,1,"span",26),t()),a&2){let e=m.$implicit;s("value",e.id),l(),S(" ",e.name," "),l(),s("ngIf",e.description)}}function At(a,m){a&1&&(n(0,"mat-error"),i(1," El plan de servicio es requerido "),t())}function Bt(a,m){a&1&&(n(0,"mat-error"),i(1," Los d\xEDas de cr\xE9dito deben ser mayor o igual a 0 "),t())}function zt(a,m){a&1&&(n(0,"mat-error"),i(1," Formato de email inv\xE1lido "),t())}function qt(a,m){a&1&&(n(0,"div",3)(1,"h3",4),i(2,"Configuraci\xF3n de FacturAPI"),t(),n(3,"div",5)(4,"mat-form-field",6)(5,"mat-label"),i(6,"Ambiente"),t(),n(7,"mat-select",28)(8,"mat-option",29),i(9,"Seleccione un ambiente"),t(),n(10,"mat-option",30),i(11,"Desarrollo (dev.facturapi.cl)"),t(),n(12,"mat-option",31),i(13,"Producci\xF3n (prod.facturapi.cl)"),t()(),n(14,"mat-icon",8),i(15,"cloud"),t(),n(16,"mat-hint"),i(17,"Ambiente de FacturAPI a utilizar"),t()(),n(18,"mat-form-field",6)(19,"mat-label"),i(20,"Token FacturAPI"),t(),p(21,"input",32),n(22,"mat-icon",8),i(23,"vpn_key"),t(),n(24,"mat-hint"),i(25,"Token de autenticaci\xF3n para FacturAPI"),t()()(),n(26,"p",33)(27,"mat-icon",34),i(28,"info"),t(),i(29," Si no se configura, se utilizar\xE1 la configuraci\xF3n global de FacturAPI. "),t()())}function Vt(a,m){a&1&&(n(0,"mat-error"),i(1," El nombre del sistema es requerido "),t())}function jt(a,m){a&1&&(n(0,"mat-error"),i(1," La capacidad debe ser mayor o igual a 0 "),t())}function Rt(a,m){if(a&1&&(n(0,"div",3)(1,"h3",4),i(2,"Configuraci\xF3n del Sistema"),t(),n(3,"div",35)(4,"mat-form-field",6)(5,"mat-label"),i(6,"Nombre del Sistema"),t(),p(7,"input",36),n(8,"mat-icon",8),i(9,"label"),t(),c(10,Vt,2,0,"mat-error",9),t(),n(11,"div",5)(12,"mat-form-field",6)(13,"mat-label"),i(14,"Capacidad M\xE1xima"),t(),p(15,"input",37),n(16,"mat-icon",8),i(17,"directions_car"),t(),n(18,"mat-hint"),i(19,"N\xFAmero m\xE1ximo de veh\xEDculos que puede albergar el estacionamiento"),t(),c(20,jt,2,0,"mat-error",9),t(),n(21,"div",38)(22,"div",39)(23,"mat-checkbox",40)(24,"span",41),i(25,"POS TUU Habilitado"),t()(),n(26,"mat-icon",42),i(27,"info"),t()(),n(28,"div",39)(29,"mat-checkbox",43)(30,"span",41),i(31,"Boleta Electr\xF3nica Habilitada"),t()(),n(32,"mat-icon",42),i(33,"info"),t()(),n(34,"div",39)(35,"mat-checkbox",44)(36,"span",41),i(37,"Lavado de Autos Habilitado"),t()(),n(38,"mat-icon",42),i(39,"info"),t()()()()()()),a&2){let e,o,r=g();l(3),s("formGroup",r.settingsForm),l(7),s("ngIf",(e=r.tenantForm.get("settings.name"))==null?null:e.hasError("required")),l(10),s("ngIf",(o=r.tenantForm.get("settings.max_capacity"))==null?null:o.hasError("min")),l(6),s("matTooltip","Habilita la integraci\xF3n con POS TUU"),l(6),s("matTooltip","Habilita la emisi\xF3n de boletas electr\xF3nicas"),l(6),s("matTooltip","Habilita el m\xF3dulo de lavado de autos en el sistema")}}function Lt(a,m){a&1&&(n(0,"mat-error"),i(1," El nombre es requerido "),t())}function Ht(a,m){a&1&&(n(0,"mat-error"),i(1," Debe tener al menos 2 caracteres "),t())}function Ot(a,m){a&1&&(n(0,"mat-error"),i(1," El email es requerido "),t())}function $t(a,m){a&1&&(n(0,"mat-error"),i(1," Formato de email inv\xE1lido "),t())}function Ut(a,m){a&1&&(n(0,"mat-error"),i(1," La contrase\xF1a es requerida "),t())}function Gt(a,m){a&1&&(n(0,"mat-error"),i(1," La contrase\xF1a debe tener al menos 6 caracteres "),t())}function Wt(a,m){if(a&1&&(n(0,"div",3)(1,"h3",4),i(2,"Usuario Principal"),t(),n(3,"div",35)(4,"div",5)(5,"mat-form-field",6)(6,"mat-label"),i(7,"Nombre del Usuario"),t(),p(8,"input",45),n(9,"mat-icon",8),i(10,"person"),t(),c(11,Lt,2,0,"mat-error",9)(12,Ht,2,0,"mat-error",9),t(),n(13,"mat-form-field",6)(14,"mat-label"),i(15,"Email"),t(),p(16,"input",46),n(17,"mat-icon",8),i(18,"email"),t(),c(19,Ot,2,0,"mat-error",9)(20,$t,2,0,"mat-error",9),t()(),n(21,"mat-form-field",6)(22,"mat-label"),i(23,"Contrase\xF1a"),t(),p(24,"input",47),n(25,"mat-icon",8),i(26,"lock"),t(),c(27,Ut,2,0,"mat-error",9)(28,Gt,2,0,"mat-error",9),t()()()),a&2){let e,o,r,d,u,f,x=g();l(3),s("formGroup",x.userForm),l(8),s("ngIf",(e=x.tenantForm.get("user.name"))==null?null:e.hasError("required")),l(),s("ngIf",(o=x.tenantForm.get("user.name"))==null?null:o.hasError("minlength")),l(7),s("ngIf",(r=x.tenantForm.get("user.email"))==null?null:r.hasError("required")),l(),s("ngIf",(d=x.tenantForm.get("user.email"))==null?null:d.hasError("email")),l(7),s("ngIf",(u=x.tenantForm.get("user.password"))==null?null:u.hasError("required")),l(),s("ngIf",(f=x.tenantForm.get("user.password"))==null?null:f.hasError("minlength"))}}function Qt(a,m){a&1&&p(0,"mat-spinner",48)}function Yt(a,m){if(a&1&&(n(0,"span"),i(1),t()),a&2){let e=g();l(),C(e.data.isEdit?"Actualizar":"Crear")}}function Zt(a,m){a&1&&(n(0,"span"),i(1,"Creando..."),t())}var Y=(()=>{class a{get settingsForm(){return this.tenantForm.get("settings")}get userForm(){return this.tenantForm.get("user")}constructor(e,o,r,d,u){this.fb=e,this.dialogRef=o,this.data=r,this.tenantService=d,this.snackBar=u,this.loading=!1}ngOnInit(){this.tenantForm=this.createForm(),this.data.isEdit&&this.data.tenant&&setTimeout(()=>{this.loadTenantData()},50)}createForm(){let e=this.data.isEdit,o={id:["",[_.required,_.minLength(2),_.pattern(/^[a-z0-9_-]+$/)]],name:["",[_.required,_.minLength(2)]],plan_id:["",_.required],rut:[""],razon_social:[""],giro:[""],direccion:[""],comuna:[""],dias_credito:[0,[_.min(0)]],correo_intercambio:["",[_.email]],facturapi_environment:[""],facturapi_token:[""],user:this.fb.group({name:["",e?[]:[_.required,_.minLength(2)]],email:["",e?[]:[_.required,_.email]],password:["",e?[]:[_.required,_.minLength(6)]]})};return e&&(o.settings=this.fb.group({name:["",_.required],pos_tuu:[!1],boleta_electronica:[!1],max_capacity:[0,[_.min(0)]],car_wash_enabled:[!1]})),this.fb.group(o)}loadTenantData(){if(this.data.tenant){console.log("Loading tenant data:",this.data.tenant);let e=this.data.tenant.settings||{};console.log("Settings from tenant:",e);let o={id:this.data.tenant.id,name:this.data.tenant.name||"",plan_id:this.data.tenant.plan_id||"",rut:this.data.tenant.rut||"",razon_social:this.data.tenant.razon_social||"",giro:this.data.tenant.giro||"",direccion:this.data.tenant.direccion||"",comuna:this.data.tenant.comuna||"",dias_credito:this.data.tenant.dias_credito||0,correo_intercambio:this.data.tenant.correo_intercambio||"",facturapi_environment:this.data.tenant.facturapi_environment||"",facturapi_token:this.data.tenant.facturapi_token||""};this.tenantForm.get("settings")&&(o.settings={name:e.name||"STPark - Sistema de Estacionamientos",pos_tuu:e.pos_tuu!==void 0?!!e.pos_tuu:!1,boleta_electronica:e.boleta_electronica!==void 0?!!e.boleta_electronica:!1,max_capacity:e.max_capacity!==void 0?Number(e.max_capacity):0,car_wash_enabled:e.car_wash_enabled!==void 0?!!e.car_wash_enabled:!1},console.log("Settings to load:",o.settings)),this.tenantForm.patchValue(o,{emitEvent:!1}),console.log("Form value after loading:",this.tenantForm.value),console.log("Settings control value:",this.tenantForm.get("settings")?.value)}}getErrorMessage(e){let o=this.tenantForm.get(e);return o?.hasError("required")?"Este campo es requerido":o?.hasError("minlength")?"Debe tener al menos 2 caracteres":o?.hasError("email")?"Formato de email inv\xE1lido":o?.hasError("pattern")?"Solo se permiten letras min\xFAsculas, n\xFAmeros, guiones y guiones bajos":"Campo inv\xE1lido"}getUserErrorMessage(e){let r=this.tenantForm.get("user")?.get(e);return r?.hasError("required")?"Este campo es requerido":r?.hasError("minlength")?e==="password"?"La contrase\xF1a debe tener al menos 6 caracteres":"Debe tener al menos 2 caracteres":r?.hasError("email")?"Formato de email inv\xE1lido":"Campo inv\xE1lido"}onSubmit(){if(this.tenantForm.valid){this.loading=!0;let e=this.tenantForm.value;if(this.data.isEdit&&this.data.tenant){let o={name:e.name.trim(),plan_id:e.plan_id,rut:e.rut?.trim()||null,razon_social:e.razon_social?.trim()||null,giro:e.giro?.trim()||null,direccion:e.direccion?.trim()||null,comuna:e.comuna?.trim()||null,dias_credito:e.dias_credito?parseInt(e.dias_credito):0,correo_intercambio:e.correo_intercambio?.trim()||null,facturapi_environment:e.facturapi_environment?.trim()||null,facturapi_token:e.facturapi_token?.trim()||null};e.settings&&(o.settings={name:e.settings.name?.trim()||"STPark - Sistema de Estacionamientos",pos_tuu:e.settings.pos_tuu!==void 0?e.settings.pos_tuu:!1,boleta_electronica:e.settings.boleta_electronica!==void 0?e.settings.boleta_electronica:!1,max_capacity:e.settings.max_capacity!==void 0?parseInt(e.settings.max_capacity):0,car_wash_enabled:e.settings.car_wash_enabled!==void 0?e.settings.car_wash_enabled:!1}),this.tenantService.updateTenant(this.data.tenant.id,o).subscribe({next:r=>{this.loading=!1,this.snackBar.open("Estacionamiento actualizado exitosamente. Si est\xE1s viendo este tenant, recarga la p\xE1gina para ver los cambios.","Cerrar",{duration:5e3}),this.dialogRef.close(!0)},error:r=>{this.loading=!1,console.error("Error updating tenant:",r);let d=r.error?.message||"Error al actualizar estacionamiento";this.snackBar.open(d,"Cerrar",{duration:5e3})}})}else{let o={id:e.id.toLowerCase().trim(),name:e.name.trim(),plan_id:e.plan_id,rut:e.rut?.trim()||null,razon_social:e.razon_social?.trim()||null,giro:e.giro?.trim()||null,direccion:e.direccion?.trim()||null,comuna:e.comuna?.trim()||null,dias_credito:e.dias_credito?parseInt(e.dias_credito):0,correo_intercambio:e.correo_intercambio?.trim()||null,facturapi_environment:e.facturapi_environment?.trim()||null,facturapi_token:e.facturapi_token?.trim()||null,user:{name:e.user.name.trim(),email:e.user.email.trim().toLowerCase(),password:e.user.password}};this.tenantService.createTenant(o).subscribe({next:r=>{this.loading=!1,this.snackBar.open("Estacionamiento creado exitosamente","Cerrar",{duration:3e3}),this.dialogRef.close(!0)},error:r=>{this.loading=!1,console.error("Error creating tenant:",r);let d=r.error?.message||"Error al crear estacionamiento";this.snackBar.open(d,"Cerrar",{duration:5e3})}})}}else this.tenantForm.markAllAsTouched()}onCancel(){this.dialogRef.close(!1)}static{this.\u0275fac=function(o){return new(o||a)(h(je),h(ue),h(fe),h(W),h($))}}static{this.\u0275cmp=M({type:a,selectors:[["app-tenant-form"]],decls:101,vars:20,consts:[["mat-dialog-title",""],[1,"mr-2"],[1,"space-y-4",3,"formGroup"],[1,"mb-6"],[1,"text-lg","font-semibold","mb-4","text-gray-700"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],["appearance","outline",1,"w-full"],["matInput","","formControlName","id","placeholder","ej: estacionamiento-1",3,"readonly"],["matPrefix",""],[4,"ngIf"],["matInput","","formControlName","name","placeholder","Nombre descriptivo"],["formControlName","plan_id"],[3,"value",4,"ngFor","ngForOf"],["matInput","","formControlName","rut","placeholder","Ej: 12345678-9"],["matInput","","formControlName","razon_social","placeholder","Nombre de la empresa"],["matInput","","formControlName","giro","placeholder","Actividad econ\xF3mica"],["matInput","","formControlName","direccion","placeholder","Direcci\xF3n completa"],["matInput","","formControlName","comuna","placeholder","Comuna"],["matInput","","type","number","formControlName","dias_credito","placeholder","0","min","0"],["matInput","","type","email","formControlName","correo_intercambio","placeholder","correo@ejemplo.com"],["class","mb-6",4,"ngIf"],["align","end",1,"p-4"],["mat-button","",3,"click","disabled"],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","20","class","inline-block mr-2",4,"ngIf"],[3,"value"],["class","text-gray-500 text-sm ml-2",4,"ngIf"],[1,"text-gray-500","text-sm","ml-2"],["formControlName","facturapi_environment"],["value",""],["value","dev"],["value","prod"],["matInput","","type","password","formControlName","facturapi_token","placeholder","Token de FacturAPI"],[1,"text-sm","text-gray-500","mt-2"],[1,"align-middle","text-base"],[3,"formGroup"],["matInput","","formControlName","name","placeholder","Nombre del sistema"],["matInput","","type","number","formControlName","max_capacity","placeholder","0","min","0"],[1,"flex","flex-col","gap-4","mt-6"],[1,"flex","items-center"],["formControlName","pos_tuu"],[1,"ml-2"],[1,"ml-2","text-gray-500",3,"matTooltip"],["formControlName","boleta_electronica"],["formControlName","car_wash_enabled"],["matInput","","formControlName","name","placeholder","Nombre completo"],["matInput","","type","email","formControlName","email","placeholder","usuario@ejemplo.com"],["matInput","","type","password","formControlName","password","placeholder","M\xEDnimo 6 caracteres"],["diameter","20",1,"inline-block","mr-2"]],template:function(o,r){if(o&1&&(n(0,"h2",0)(1,"mat-icon",1),i(2,"local_parking"),t(),i(3),t(),n(4,"mat-dialog-content")(5,"form",2)(6,"div",3)(7,"h3",4),i(8,"Informaci\xF3n del Estacionamiento"),t(),n(9,"div",5)(10,"mat-form-field",6)(11,"mat-label"),i(12,"ID del Estacionamiento"),t(),p(13,"input",7),n(14,"mat-icon",8),i(15,"tag"),t(),n(16,"mat-hint"),i(17,"Solo letras min\xFAsculas, n\xFAmeros y guiones"),t(),c(18,Mt,2,0,"mat-error",9)(19,It,2,0,"mat-error",9)(20,kt,2,0,"mat-error",9),t(),n(21,"mat-form-field",6)(22,"mat-label"),i(23,"Nombre del Estacionamiento"),t(),p(24,"input",10),n(25,"mat-icon",8),i(26,"business"),t(),c(27,Dt,2,0,"mat-error",9)(28,wt,2,0,"mat-error",9),t()(),n(29,"mat-form-field",6)(30,"mat-label"),i(31,"Plan de Servicio"),t(),n(32,"mat-select",11),c(33,Pt,3,3,"mat-option",12),t(),n(34,"mat-icon",8),i(35,"card_membership"),t(),c(36,At,2,0,"mat-error",9),t()(),n(37,"div",3)(38,"h3",4),i(39,"Informaci\xF3n de Facturaci\xF3n"),t(),n(40,"div",5)(41,"mat-form-field",6)(42,"mat-label"),i(43,"RUT"),t(),p(44,"input",13),n(45,"mat-icon",8),i(46,"badge"),t()(),n(47,"mat-form-field",6)(48,"mat-label"),i(49,"Raz\xF3n Social"),t(),p(50,"input",14),n(51,"mat-icon",8),i(52,"business"),t()()(),n(53,"mat-form-field",6)(54,"mat-label"),i(55,"Giro"),t(),p(56,"input",15),n(57,"mat-icon",8),i(58,"work"),t()(),n(59,"div",5)(60,"mat-form-field",6)(61,"mat-label"),i(62,"Direcci\xF3n"),t(),p(63,"input",16),n(64,"mat-icon",8),i(65,"location_on"),t()(),n(66,"mat-form-field",6)(67,"mat-label"),i(68,"Comuna"),t(),p(69,"input",17),n(70,"mat-icon",8),i(71,"place"),t()()(),n(72,"div",5)(73,"mat-form-field",6)(74,"mat-label"),i(75,"D\xEDas de Cr\xE9dito"),t(),p(76,"input",18),n(77,"mat-icon",8),i(78,"schedule"),t(),n(79,"mat-hint"),i(80,"N\xFAmero de d\xEDas de cr\xE9dito para facturaci\xF3n"),t(),c(81,Bt,2,0,"mat-error",9),t(),n(82,"mat-form-field",6)(83,"mat-label"),i(84,"Correo Intercambio"),t(),p(85,"input",19),n(86,"mat-icon",8),i(87,"email"),t(),n(88,"mat-hint"),i(89,"Correo electr\xF3nico para intercambio de documentos"),t(),c(90,zt,2,0,"mat-error",9),t()()(),c(91,qt,30,0,"div",20)(92,Rt,40,6,"div",20)(93,Wt,29,7,"div",20),t()(),n(94,"mat-dialog-actions",21)(95,"button",22),E("click",function(){return r.onCancel()}),i(96," Cancelar "),t(),n(97,"button",23),E("click",function(){return r.onSubmit()}),c(98,Qt,1,0,"mat-spinner",24)(99,Yt,2,1,"span",9)(100,Zt,2,0,"span",9),t()()),o&2){let d,u,f,x,Z,J,K,X;l(3),S(" ",r.data.isEdit?"Editar Estacionamiento":"Nuevo Estacionamiento",`
`),l(2),s("formGroup",r.tenantForm),l(8),s("readonly",r.data.isEdit),l(5),s("ngIf",(d=r.tenantForm.get("id"))==null?null:d.hasError("required")),l(),s("ngIf",(u=r.tenantForm.get("id"))==null?null:u.hasError("pattern")),l(),s("ngIf",(f=r.tenantForm.get("id"))==null?null:f.hasError("minlength")),l(7),s("ngIf",(x=r.tenantForm.get("name"))==null?null:x.hasError("required")),l(),s("ngIf",(Z=r.tenantForm.get("name"))==null?null:Z.hasError("minlength")),l(5),s("ngForOf",r.data.plans),l(3),s("ngIf",(J=r.tenantForm.get("plan_id"))==null?null:J.hasError("required")),l(45),s("ngIf",(K=r.tenantForm.get("dias_credito"))==null?null:K.hasError("min")),l(9),s("ngIf",(X=r.tenantForm.get("correo_intercambio"))==null?null:X.hasError("email")),l(),s("ngIf",r.data.isEdit),l(),s("ngIf",r.data.isEdit&&r.settingsForm),l(),s("ngIf",!r.data.isEdit),l(2),s("disabled",r.loading),l(2),s("disabled",r.loading||r.tenantForm.invalid),l(),s("ngIf",r.loading),l(),s("ngIf",!r.loading),l(),s("ngIf",r.loading)}},dependencies:[k,ce,I,Le,Ae,V,Be,j,Ne,Ve,ze,qe,D,ge,xe,he,P,N,w,Se,Ee,be,L,R,B,A,q,z,U,Oe,pe,O,H,Ue,$e,Me,Fe],encapsulation:2})}}return a})();function Jt(a,m){a&1&&(n(0,"th",46),i(1,"ID"),t())}function Kt(a,m){if(a&1&&(n(0,"td",47)(1,"div",48)(2,"mat-icon",49),i(3,"tag"),t(),n(4,"span",50),i(5),t()()()),a&2){let e=m.$implicit;l(5),C(e.id)}}function Xt(a,m){a&1&&(n(0,"th",51),i(1,"Nombre"),t())}function en(a,m){if(a&1&&(n(0,"td",47)(1,"span",52),i(2),t()()),a&2){let e=m.$implicit;l(2),C(e.name||e.id)}}function tn(a,m){a&1&&(n(0,"th",53),i(1,"Plan de Servicio"),t())}function nn(a,m){if(a&1&&(n(0,"mat-chip",56),i(1),t()),a&2){let e=g().$implicit,o=g();l(),S(" ",o.getPlanName(e)," ")}}function an(a,m){a&1&&(n(0,"span",57),i(1,"Sin plan"),t())}function rn(a,m){if(a&1&&(n(0,"td",47),c(1,nn,2,1,"mat-chip",54)(2,an,2,0,"span",55),t()),a&2){let e=m.$implicit;l(),s("ngIf",e.plan),l(),s("ngIf",!e.plan)}}function on(a,m){a&1&&(n(0,"th",53),i(1,"Sesiones Mensuales"),t())}function ln(a,m){if(a&1&&(n(0,"td",47)(1,"div",48)(2,"mat-icon",58),i(3,"local_parking"),t(),n(4,"span"),i(5),t()()()),a&2){let e=m.$implicit,o=g();l(4),ne(o.getSessionsProgressColor(e)),l(),S(" ",o.getSessionsDisplay(e)," ")}}function mn(a,m){a&1&&(n(0,"th",59),i(1,"Fecha de Inicio"),t())}function sn(a,m){if(a&1&&(n(0,"td",47)(1,"span",4),i(2),t()()),a&2){let e=m.$implicit,o=g();l(2),C(o.formatDate(e.created_at))}}function dn(a,m){a&1&&(n(0,"th",60),i(1,"Usuarios"),t())}function cn(a,m){if(a&1&&(n(0,"td",47)(1,"div",48)(2,"mat-icon",58),i(3,"people"),t(),n(4,"span",61),i(5),t()()()),a&2){let e=m.$implicit;l(5),C(e.users_count||0)}}function pn(a,m){a&1&&(n(0,"th",53),i(1,"Acciones"),t())}function un(a,m){if(a&1){let e=Q();n(0,"td",47)(1,"button",62)(2,"mat-icon"),i(3,"more_vert"),t()(),n(4,"mat-menu",null,0)(6,"button",63),E("click",function(){let r=T(e).$implicit,d=g();return y(d.viewTenant(r))}),n(7,"mat-icon"),i(8,"visibility"),t(),i(9," Ver detalles "),t(),n(10,"button",63),E("click",function(){let r=T(e).$implicit,d=g();return y(d.editTenant(r))}),n(11,"mat-icon"),i(12,"edit"),t(),i(13," Editar "),t(),n(14,"button",64),E("click",function(){let r=T(e).$implicit,d=g();return y(d.deleteTenant(r))}),n(15,"mat-icon"),i(16,"delete"),t(),i(17," Eliminar "),t()()()}if(a&2){let e=oe(5);l(),s("matMenuTriggerFor",e)}}function fn(a,m){a&1&&p(0,"tr",65)}function _n(a,m){a&1&&p(0,"tr",66)}function gn(a,m){a&1&&(n(0,"div",67),p(1,"mat-spinner",68),t())}function hn(a,m){a&1&&(n(0,"div",69)(1,"mat-icon",70),i(2,"local_parking"),t(),n(3,"h3",71),i(4,"No hay estacionamientos registrados"),t(),n(5,"p",49),i(6,"Los estacionamientos aparecer\xE1n aqu\xED cuando se registren."),t()())}function xn(a,m){if(a&1){let e=Q();n(0,"mat-paginator",72),E("page",function(r){T(e);let d=g();return y(d.onPageChange(r))}),t()}if(a&2){let e=g();s("length",e.totalItems)("pageSize",e.pageSize)("pageIndex",e.currentPage)("pageSizeOptions",e.pageSizeOptions)("showFirstLastButtons",!0)}}var ci=(()=>{class a{constructor(e,o,r,d,u,f,x){this.tenantService=e,this.planService=o,this.dialog=r,this.snackBar=d,this.configService=u,this.navigationService=f,this.authService=x,this._unsubscribeAll=new te,this.tenants=[],this.loading=!1,this.displayedColumns=["id","name","plan","sessions_count","created_at","users_count","actions"],this.totalItems=0,this.pageSize=10,this.currentPage=0,this.pageSizeOptions=[5,10,25,50],this.sortBy="created_at",this.sortOrder="desc",this.filters={name:""},this.plans=[]}ngOnInit(){this.loadTenants(),this.loadPlans()}ngAfterViewInit(){this.sort&&this.sort.sortChange.pipe(F(this._unsubscribeAll)).subscribe(e=>{this.sortBy=e.active,this.sortOrder=e.direction==="asc"?"asc":"desc",this.currentPage=0,this.loadTenants()})}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}loadTenants(){this.loading=!0;let e=ee({page:this.currentPage+1,per_page:this.pageSize,sort_by:this.sortBy,sort_order:this.sortOrder},this.filters);this.tenantService.getTenants(e).pipe(F(this._unsubscribeAll)).subscribe({next:o=>{this.tenants=o.data?.data||[],this.totalItems=o.data?.total||0,this.loading=!1},error:o=>{console.error("Error loading tenants:",o),this.loading=!1,o.status===403?this.snackBar.open("No tiene permisos para acceder a esta funcionalidad","Cerrar",{duration:5e3}):this.snackBar.open("Error al cargar estacionamientos","Cerrar",{duration:3e3})}})}loadPlans(){this.planService.getPlans({status:"ACTIVE",per_page:100}).pipe(F(this._unsubscribeAll)).subscribe({next:e=>{this.plans=e.data?.data||[]},error:e=>{console.error("Error loading plans:",e)}})}formatDate(e){if(!e)return"-";let o=new Date(e);return new Intl.DateTimeFormat("es-CL",{year:"numeric",month:"2-digit",day:"2-digit"}).format(o)}getPlanName(e){return e.plan?.name||"-"}get totalUsers(){return this.tenants.reduce((e,o)=>e+(o.users_count||0),0)}getSessionsDisplay(e){let o=e.sessions_count??0,r=e.max_sessions;return r==null?`${o}`:`${o}/${r}`}getSessionsProgressColor(e){if(!e.max_sessions)return"text-gray-600";let o=e.sessions_count??0,r=e.max_sessions,d=o/r*100;return d>=90?"text-red-600 font-semibold":d>=75?"text-orange-600 font-semibold":"text-gray-600"}get tenantsThisMonth(){let e=new Date;return this.tenants.filter(o=>{if(!o.created_at)return!1;let r=new Date(o.created_at);return r.getMonth()===e.getMonth()&&r.getFullYear()===e.getFullYear()}).length}createTenant(){this.dialog.open(Y,{width:"800px",maxWidth:"90vw",data:{isEdit:!1,plans:this.plans}}).afterClosed().subscribe(o=>{o&&this.loadTenants()})}viewTenant(e){this.tenantService.getTenant(e.id).subscribe({next:o=>{let r=o.data,d=[{label:"ID",key:"id",icon:"tag",type:"text"},{label:"Nombre",key:"name",icon:"business",type:"text"},{label:"Plan de Servicio",key:"plan.name",icon:"card_membership",type:"chip",chipColor:()=>"primary"},{label:"Cantidad de Usuarios",key:"users_count",icon:"people",type:"text",format:f=>f?`${f} usuarios`:"0 usuarios"},{label:"Fecha de Inicio de Servicio",key:"created_at",icon:"calendar_today",type:"date"},{label:"\xDAltima Actualizaci\xF3n",key:"updated_at",icon:"update",type:"date"},{label:"Nombre del Sistema",key:"settings.name",icon:"label",type:"text"},{label:"Capacidad M\xE1xima",key:"settings.max_capacity",icon:"directions_car",type:"text",format:f=>f?`${f} veh\xEDculos`:"No especificado"},{label:"POS TUU Habilitado",key:"settings.pos_tuu",icon:"point_of_sale",type:"boolean"},{label:"Boleta Electr\xF3nica Habilitada",key:"settings.boleta_electronica",icon:"receipt",type:"boolean"},{label:"Idioma",key:"settings.language",icon:"language",type:"text",format:f=>f?{es:"Espa\xF1ol",en:"English",pt:"Portugu\xEAs"}[f]||f:"No especificado"},{label:"Moneda",key:"settings.currency",icon:"attach_money",type:"text"},{label:"Zona Horaria",key:"settings.timezone",icon:"schedule",type:"text"}],u=this.dialog.open(ft,{width:"700px",data:{title:"Detalles del Estacionamiento",data:r,fields:d,actions:[{label:"Editar",icon:"edit",color:"primary",action:()=>{u.close(),this.editTenant(e)}}]}})},error:o=>{console.error("Error loading tenant:",o),this.snackBar.open("Error al cargar los datos del estacionamiento","Cerrar",{duration:3e3})}})}editTenant(e){this.tenantService.getTenant(e.id).subscribe({next:o=>{let r=o.data;console.log("Tenant loaded for edit:",r),console.log("Settings:",r.settings),this.dialog.open(Y,{width:"800px",maxWidth:"90vw",data:{isEdit:!0,tenant:r,plans:this.plans}}).afterClosed().subscribe(u=>{u&&(this.loadTenants(),this.navigationService.get().subscribe(),this.refreshConfigIfCurrentTenant(r.id))})},error:o=>{console.error("Error loading tenant:",o),this.snackBar.open("Error al cargar los datos del estacionamiento","Cerrar",{duration:3e3})}})}refreshConfigIfCurrentTenant(e){let o=this.authService.getCurrentTenant();localStorage.getItem("current_tenant")===e&&(this.authService.isCentralAdminMode()?console.log("Tenant actualizado. Cambia a modo tenant o recarga la p\xE1gina para ver los cambios."):(console.log("Recargando configuraci\xF3n para el tenant actual:",e),this.configService.loadConfig().subscribe({next:d=>{console.log("Configuraci\xF3n recargada despu\xE9s de actualizar tenant:",d),setTimeout(()=>{this.navigationService.get().subscribe()},100)},error:d=>{console.error("Error al recargar configuraci\xF3n:",d)}})))}deleteTenant(e){confirm(`\xBFEst\xE1 seguro de eliminar el estacionamiento ${e.name||e.id}? Esta acci\xF3n no se puede deshacer.`)&&this.tenantService.deleteTenant(e.id).subscribe({next:()=>{this.snackBar.open("Estacionamiento eliminado correctamente","Cerrar",{duration:3e3}),this.loadTenants()},error:o=>{console.error("Error deleting tenant:",o);let r=o.error?.message||"Error al eliminar estacionamiento";this.snackBar.open(r,"Cerrar",{duration:5e3})}})}applyFilters(){this.currentPage=0,this.loadTenants()}clearFilters(){this.filters={name:""},this.currentPage=0,this.loadTenants()}onPageChange(e){this.currentPage=e.pageIndex,this.pageSize=e.pageSize,this.loadTenants()}static{this.\u0275fac=function(o){return new(o||a)(h(W),h(_t),h(_e),h($),h(Te),h(Ce),h(ye))}}static{this.\u0275cmp=M({type:a,selectors:[["app-tenants"]],viewQuery:function(o,r){if(o&1&&ie(G,5),o&2){let d;ae(d=re())&&(r.sort=d.first)}},features:[de([{provide:ot,useValue:ut()}])],decls:91,vars:12,consts:[["tenantMenu","matMenu"],[1,"p-6","w-full"],[1,"flex","items-center","justify-between","mb-6"],[1,"text-2xl","font-bold","text-gray-900"],[1,"text-gray-600"],["mat-raised-button","","color","primary",1,"rounded-sm",3,"click"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-6","mb-6"],[1,"p-6"],[1,"flex","items-center"],[1,"p-3","bg-blue-100","rounded-full"],[1,"text-blue-600"],[1,"ml-4"],[1,"text-sm","font-medium","text-gray-600"],[1,"text-2xl","font-bold","text-blue-600"],[1,"p-3","bg-green-100","rounded-full"],[1,"text-green-600"],[1,"text-2xl","font-bold","text-green-600"],[1,"p-3","bg-purple-100","rounded-full"],[1,"text-purple-600"],[1,"text-2xl","font-bold","text-purple-600"],[1,"mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],["appearance","outline"],["matInput","","placeholder","Nombre o ID",3,"ngModelChange","ngModel"],[1,"flex","justify-end","gap-2","mt-4"],["mat-stroked-button","",1,"rounded-sm",3,"click"],[1,"overflow-x-auto"],["mat-table","","matSort","",1,"w-full",3,"dataSource","matSortActive","matSortDirection"],["matColumnDef","id"],["mat-header-cell","","mat-sort-header","id",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","name"],["mat-header-cell","","mat-sort-header","name",4,"matHeaderCellDef"],["matColumnDef","plan"],["mat-header-cell","",4,"matHeaderCellDef"],["matColumnDef","sessions_count"],["matColumnDef","created_at"],["mat-header-cell","","mat-sort-header","created_at",4,"matHeaderCellDef"],["matColumnDef","users_count"],["mat-header-cell","","mat-sort-header","users_count",4,"matHeaderCellDef"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","flex justify-center items-center py-8",4,"ngIf"],["class","text-center py-8",4,"ngIf"],["class","mt-4",3,"length","pageSize","pageIndex","pageSizeOptions","showFirstLastButtons","page",4,"ngIf"],["mat-header-cell","","mat-sort-header","id"],["mat-cell",""],[1,"flex","items-center","gap-2"],[1,"text-gray-500"],[1,"font-mono","text-sm"],["mat-header-cell","","mat-sort-header","name"],[1,"font-semibold"],["mat-header-cell",""],["class","bg-blue-100 text-blue-800",4,"ngIf"],["class","text-gray-400",4,"ngIf"],[1,"bg-blue-100","text-blue-800"],[1,"text-gray-400"],[1,"text-gray-500","text-sm"],["mat-header-cell","","mat-sort-header","created_at"],["mat-header-cell","","mat-sort-header","users_count"],[1,"font-medium"],["mat-icon-button","",1,"rounded-sm",3,"matMenuTriggerFor"],["mat-menu-item","",3,"click"],["mat-menu-item","",1,"text-red-600",3,"click"],["mat-header-row",""],["mat-row",""],[1,"flex","justify-center","items-center","py-8"],["diameter","40"],[1,"text-center","py-8"],[1,"text-gray-400","text-6xl"],[1,"text-lg","font-medium","text-gray-900","mt-4"],[1,"mt-4",3,"page","length","pageSize","pageIndex","pageSizeOptions","showFirstLastButtons"]],template:function(o,r){o&1&&(n(0,"div",1)(1,"div",2)(2,"div")(3,"h1",3),i(4,"Estacionamientos"),t(),n(5,"p",4),i(6,"Gestiona los estacionamientos (tenants) registrados"),t()(),n(7,"button",5),E("click",function(){return r.createTenant()}),n(8,"mat-icon"),i(9,"add"),t(),i(10," Nuevo Estacionamiento "),t()(),n(11,"div",6)(12,"mat-card")(13,"mat-card-content",7)(14,"div",8)(15,"div",9)(16,"mat-icon",10),i(17,"local_parking"),t()(),n(18,"div",11)(19,"p",12),i(20,"Total Estacionamientos"),t(),n(21,"p",13),i(22),t()()()()(),n(23,"mat-card")(24,"mat-card-content",7)(25,"div",8)(26,"div",14)(27,"mat-icon",15),i(28,"people"),t()(),n(29,"div",11)(30,"p",12),i(31,"Total Usuarios"),t(),n(32,"p",16),i(33),t()()()()(),n(34,"mat-card")(35,"mat-card-content",7)(36,"div",8)(37,"div",17)(38,"mat-icon",18),i(39,"calendar_today"),t()(),n(40,"div",11)(41,"p",12),i(42,"Este Mes"),t(),n(43,"p",19),i(44),t()()()()()(),n(45,"mat-card",20)(46,"mat-card-content",7)(47,"div",21)(48,"mat-form-field",22)(49,"mat-label"),i(50,"Buscar estacionamiento"),t(),n(51,"input",23),se("ngModelChange",function(u){return me(r.filters.name,u)||(r.filters.name=u),u}),t()()(),n(52,"div",24)(53,"button",25),E("click",function(){return r.clearFilters()}),n(54,"mat-icon"),i(55,"clear"),t(),i(56," Limpiar "),t(),n(57,"button",5),E("click",function(){return r.applyFilters()}),n(58,"mat-icon"),i(59,"search"),t(),i(60," Filtrar "),t()()()(),n(61,"mat-card")(62,"mat-card-content",7)(63,"div",26)(64,"table",27),b(65,28),c(66,Jt,2,0,"th",29)(67,Kt,6,1,"td",30),v(),b(68,31),c(69,Xt,2,0,"th",32)(70,en,3,1,"td",30),v(),b(71,33),c(72,tn,2,0,"th",34)(73,rn,3,2,"td",30),v(),b(74,35),c(75,on,2,0,"th",34)(76,ln,6,3,"td",30),v(),b(77,36),c(78,mn,2,0,"th",37)(79,sn,3,1,"td",30),v(),b(80,38),c(81,dn,2,0,"th",39)(82,cn,6,1,"td",30),v(),b(83,40),c(84,pn,2,0,"th",34)(85,un,18,1,"td",30),v(),c(86,fn,1,0,"tr",41)(87,_n,1,0,"tr",42),t(),c(88,gn,2,0,"div",43)(89,hn,7,0,"div",44),t(),c(90,xn,1,5,"mat-paginator",45),t()()()),o&2&&(l(22),C(r.tenants.length),l(11),S(" ",r.totalUsers," "),l(11),S(" ",r.tenantsThisMonth," "),l(7),le("ngModel",r.filters.name),l(13),s("dataSource",r.tenants)("matSortActive",r.sortBy)("matSortDirection",r.sortOrder),l(22),s("matHeaderRowDef",r.displayedColumns),l(),s("matRowDefColumns",r.displayedColumns),l(),s("ngIf",r.loading),l(),s("ngIf",!r.loading&&r.tenants.length===0),l(),s("ngIf",r.totalItems>0))},dependencies:[k,I,Re,V,j,Pe,rt,Ye,Je,tt,Ke,Ze,nt,Xe,et,it,at,Qe,Ge,We,B,A,ve,q,z,O,H,P,N,w,L,R,we,ke,Ie,De,pt,ct,U,mt,lt,dt,G,st,D,He],encapsulation:2})}}return a})();export{ci as TenantsComponent};
