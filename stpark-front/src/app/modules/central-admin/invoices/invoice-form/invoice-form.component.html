<h2 mat-dialog-title>
  <mat-icon class="mr-2">receipt</mat-icon>
  {{ data.isEdit ? 'Editar Factura' : 'Nueva Factura' }}
</h2>

<mat-dialog-content>
  <form [formGroup]="invoiceForm" class="space-y-4">
    <!-- Información de la Factura -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Información de la Factura</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Estacionamiento</mat-label>
          <mat-select formControlName="tenant_id">
            <mat-option *ngFor="let tenant of data.tenants" [value]="tenant.id">
              {{ tenant.name || tenant.id }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>local_parking</mat-icon>
          <mat-error *ngIf="invoiceForm.get('tenant_id')?.hasError('required')">
            El estacionamiento es requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Nombre del Cliente</mat-label>
          <input matInput formControlName="client_name" placeholder="Nombre completo del cliente">
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="invoiceForm.get('client_name')?.hasError('required')">
            El nombre del cliente es requerido
          </mat-error>
          <mat-error *ngIf="invoiceForm.get('client_name')?.hasError('minlength')">
            Debe tener al menos 2 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>RUT del Cliente</mat-label>
          <input matInput formControlName="client_rut" placeholder="12345678-9">
          <mat-icon matPrefix>badge</mat-icon>
          <mat-error *ngIf="invoiceForm.get('client_rut')?.hasError('required')">
            El RUT es requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Fecha de Emisión</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="emission_date">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-icon matPrefix>calendar_today</mat-icon>
          <mat-error *ngIf="invoiceForm.get('emission_date')?.hasError('required')">
            La fecha de emisión es requerida
          </mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Notas</mat-label>
        <textarea matInput formControlName="notes" rows="3" placeholder="Notas adicionales sobre la factura"></textarea>
        <mat-icon matPrefix>note</mat-icon>
      </mat-form-field>
    </div>

    <!-- Items de la Factura -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-700">Items de la Factura</h3>
        <button type="button" mat-raised-button color="primary" (click)="addItem()">
          <mat-icon>add</mat-icon>
          Agregar Item
        </button>
      </div>

      <div formArrayName="items" class="space-y-4">
        <div *ngFor="let item of itemsFormArray.controls; let i = index" [formGroupName]="i" class="border border-gray-200 rounded-lg p-4">
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-md font-medium text-gray-700">Item {{ i + 1 }}</h4>
            <button type="button" mat-icon-button color="warn" (click)="removeItem(i)" [disabled]="itemsFormArray.length === 1">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full md:col-span-2">
              <mat-label>Descripción</mat-label>
              <input matInput formControlName="description" placeholder="Descripción del item">
              <mat-icon matPrefix>description</mat-icon>
              <mat-error *ngIf="itemsFormArray.at(i).get('description')?.hasError('required')">
                La descripción es requerida
              </mat-error>
              <mat-error *ngIf="itemsFormArray.at(i).get('description')?.hasError('minlength')">
                Debe tener al menos 2 caracteres
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Cantidad</mat-label>
              <input matInput type="number" formControlName="quantity" placeholder="1" min="1">
              <mat-icon matPrefix>numbers</mat-icon>
              <mat-error *ngIf="itemsFormArray.at(i).get('quantity')?.hasError('required')">
                La cantidad es requerida
              </mat-error>
              <mat-error *ngIf="itemsFormArray.at(i).get('quantity')?.hasError('min')">
                La cantidad debe ser mayor a 0
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Precio Unitario</mat-label>
              <input matInput type="number" formControlName="unit_price" placeholder="0" min="0" step="0.01">
              <mat-icon matPrefix>attach_money</mat-icon>
              <mat-error *ngIf="itemsFormArray.at(i).get('unit_price')?.hasError('required')">
                El precio unitario es requerido
              </mat-error>
              <mat-error *ngIf="itemsFormArray.at(i).get('unit_price')?.hasError('min')">
                El precio debe ser mayor o igual a 0
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Subtotal</mat-label>
              <input matInput type="number" formControlName="subtotal" readonly>
              <mat-icon matPrefix>calculate</mat-icon>
              <mat-hint>Calculado automáticamente</mat-hint>
              <mat-error *ngIf="itemsFormArray.at(i).get('subtotal')?.hasError('required')">
                El subtotal es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full md:col-span-2">
              <mat-label>Notas del Item</mat-label>
              <textarea matInput formControlName="notes" rows="2" placeholder="Notas adicionales sobre este item"></textarea>
              <mat-icon matPrefix>note</mat-icon>
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>

    <!-- Totales -->
    <div class="mb-6 border-t-2 border-gray-300 pt-4">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Totales</h3>
      <div class="flex justify-end">
        <div class="w-80 space-y-2">
          <div class="flex justify-between">
            <span class="text-gray-600 font-medium">Monto Neto:</span>
            <span class="font-semibold text-gray-900">{{ formatAmount(netAmount) }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 font-medium">IVA (19%):</span>
            <span class="font-semibold text-gray-900">{{ formatAmount(ivaAmount) }}</span>
          </div>
          <div class="flex justify-between text-lg font-bold border-t-2 border-gray-300 pt-2">
            <span class="text-gray-900">Total:</span>
            <span class="text-blue-600">{{ formatAmount(totalAmount) }}</span>
          </div>
        </div>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="p-4">
  <button mat-button (click)="onCancel()" [disabled]="loading">
    Cancelar
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()" 
    [disabled]="loading || invoiceForm.invalid || itemsFormArray.length === 0">
    <mat-spinner *ngIf="loading" diameter="20" class="inline-block mr-2"></mat-spinner>
    <span *ngIf="!loading">{{ data.isEdit ? 'Actualizar' : 'Crear' }}</span>
    <span *ngIf="loading">Guardando...</span>
  </button>
</mat-dialog-actions>


