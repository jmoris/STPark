<h2 mat-dialog-title>
  <mat-icon class="mr-2">{{ data.showTenantAssignment ? 'local_parking' : 'person' }}</mat-icon>
  <span *ngIf="data.showTenantAssignment">Asignar Usuario a Estacionamientos</span>
  <span *ngIf="!data.showTenantAssignment">{{ data.isEdit ? 'Editar Usuario' : 'Nuevo Usuario' }}</span>
</h2>

<mat-dialog-content>
  <!-- Formulario de Usuario (solo si no es modo asignación) -->
  <form [formGroup]="userForm" class="space-y-4" *ngIf="!data.showTenantAssignment">
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Información del Usuario</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="name" placeholder="Nombre completo">
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="userForm.get('name')?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="userForm.get('name')?.hasError('minlength')">
            Debe tener al menos 2 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" placeholder="usuario@ejemplo.com">
          <mat-icon matPrefix>email</mat-icon>
          <mat-error *ngIf="userForm.get('email')?.hasError('required')">
            El email es requerido
          </mat-error>
          <mat-error *ngIf="userForm.get('email')?.hasError('email')">
            Formato de email inválido
          </mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-full" *ngIf="!data.isEdit">
        <mat-label>Contraseña</mat-label>
        <input matInput type="password" formControlName="password" placeholder="Mínimo 6 caracteres">
        <mat-icon matPrefix>lock</mat-icon>
        <mat-error *ngIf="userForm.get('password')?.hasError('required')">
          La contraseña es requerida
        </mat-error>
        <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
          La contraseña debe tener al menos 6 caracteres
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full" *ngIf="data.isEdit">
        <mat-label>Nueva Contraseña (opcional)</mat-label>
        <input matInput type="password" formControlName="password" placeholder="Dejar vacío para mantener la actual">
        <mat-icon matPrefix>lock</mat-icon>
        <mat-hint>Deje vacío si no desea cambiar la contraseña</mat-hint>
        <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
          La contraseña debe tener al menos 6 caracteres
        </mat-error>
      </mat-form-field>

      <div class="flex items-center mt-4">
        <mat-checkbox formControlName="is_central_admin">
          <span class="ml-2">Administrador Central</span>
        </mat-checkbox>
        <mat-icon class="ml-2 text-gray-500" [matTooltip]="'Concede permisos de administración central al usuario'">info</mat-icon>
      </div>
    </div>
  </form>

  <!-- Asignación de Estacionamientos -->
  <div *ngIf="data.showTenantAssignment" class="mb-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">Seleccionar Estacionamientos</h3>
    <p class="text-gray-600 mb-4">Seleccione los estacionamientos a los que desea asignar al usuario <strong>{{ data.user?.name }}</strong></p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      <mat-card 
        *ngFor="let tenant of tenants" 
        [class.bg-blue-50]="isTenantSelected(tenant)"
        [class.border-blue-500]="isTenantSelected(tenant)"
        class="cursor-pointer border-2 transition-colors"
        (click)="toggleTenant(tenant)">
        <mat-card-content class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-semibold">{{ tenant.name || tenant.id }}</h4>
              <p class="text-sm text-gray-600">ID: {{ tenant.id }}</p>
            </div>
            <mat-icon *ngIf="isTenantSelected(tenant)" class="text-blue-600">check_circle</mat-icon>
            <mat-icon *ngIf="!isTenantSelected(tenant)" class="text-gray-400">radio_button_unchecked</mat-icon>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Estacionamientos seleccionados -->
    <div *ngIf="selectedTenants.length > 0" class="mt-4">
      <h4 class="text-sm font-semibold mb-2">Estacionamientos seleccionados ({{ selectedTenants.length }}):</h4>
      <div class="flex flex-wrap gap-2">
        <mat-chip *ngFor="let tenant of selectedTenants" class="bg-blue-100 text-blue-800">
          {{ tenant.name || tenant.id }}
        </mat-chip>
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="p-4">
  <button mat-button (click)="onCancel()" [disabled]="loading">
    Cancelar
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()" 
    [disabled]="loading || (!data.showTenantAssignment && userForm.invalid)">
    <mat-spinner *ngIf="loading" diameter="20" class="inline-block mr-2"></mat-spinner>
    <span *ngIf="!loading">
      <span *ngIf="data.showTenantAssignment">Asignar</span>
      <span *ngIf="!data.showTenantAssignment">{{ data.isEdit ? 'Actualizar' : 'Crear' }}</span>
    </span>
    <span *ngIf="loading">Procesando...</span>
  </button>
</mat-dialog-actions>
