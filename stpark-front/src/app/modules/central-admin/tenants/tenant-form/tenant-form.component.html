<h2 mat-dialog-title>
  <mat-icon class="mr-2">local_parking</mat-icon>
  {{ data.isEdit ? 'Editar Estacionamiento' : 'Nuevo Estacionamiento' }}
</h2>

<mat-dialog-content>
  <form [formGroup]="tenantForm" class="space-y-4">
    <!-- Información del Estacionamiento -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Información del Estacionamiento</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>ID del Estacionamiento</mat-label>
          <input matInput formControlName="id" placeholder="ej: estacionamiento-1" [readonly]="data.isEdit">
          <mat-icon matPrefix>tag</mat-icon>
          <mat-hint>Solo letras minúsculas, números y guiones</mat-hint>
          <mat-error *ngIf="tenantForm.get('id')?.hasError('required')">
            El ID es requerido
          </mat-error>
          <mat-error *ngIf="tenantForm.get('id')?.hasError('pattern')">
            Solo se permiten letras minúsculas, números, guiones y guiones bajos
          </mat-error>
          <mat-error *ngIf="tenantForm.get('id')?.hasError('minlength')">
            Debe tener al menos 2 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Nombre del Estacionamiento</mat-label>
          <input matInput formControlName="name" placeholder="Nombre descriptivo">
          <mat-icon matPrefix>business</mat-icon>
          <mat-error *ngIf="tenantForm.get('name')?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="tenantForm.get('name')?.hasError('minlength')">
            Debe tener al menos 2 caracteres
          </mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Plan de Servicio</mat-label>
        <mat-select formControlName="plan_id">
          <mat-option *ngFor="let plan of data.plans" [value]="plan.id">
            {{ plan.name }}
            <span *ngIf="plan.description" class="text-gray-500 text-sm ml-2">
              - {{ plan.description }}
            </span>
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>card_membership</mat-icon>
        <mat-error *ngIf="tenantForm.get('plan_id')?.hasError('required')">
          El plan de servicio es requerido
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Información de Facturación -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Información de Facturación</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>RUT</mat-label>
          <input matInput formControlName="rut" placeholder="Ej: 12345678-9">
          <mat-icon matPrefix>badge</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Razón Social</mat-label>
          <input matInput formControlName="razon_social" placeholder="Nombre de la empresa">
          <mat-icon matPrefix>business</mat-icon>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Giro</mat-label>
        <input matInput formControlName="giro" placeholder="Actividad económica">
        <mat-icon matPrefix>work</mat-icon>
      </mat-form-field>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Dirección</mat-label>
          <input matInput formControlName="direccion" placeholder="Dirección completa">
          <mat-icon matPrefix>location_on</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Comuna</mat-label>
          <input matInput formControlName="comuna" placeholder="Comuna">
          <mat-icon matPrefix>place</mat-icon>
        </mat-form-field>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Días de Crédito</mat-label>
          <input matInput type="number" formControlName="dias_credito" placeholder="0" min="0">
          <mat-icon matPrefix>schedule</mat-icon>
          <mat-hint>Número de días de crédito para facturación</mat-hint>
          <mat-error *ngIf="tenantForm.get('dias_credito')?.hasError('min')">
            Los días de crédito deben ser mayor o igual a 0
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Correo Intercambio</mat-label>
          <input matInput type="email" formControlName="correo_intercambio" placeholder="correo@ejemplo.com">
          <mat-icon matPrefix>email</mat-icon>
          <mat-hint>Correo electrónico para intercambio de documentos</mat-hint>
          <mat-error *ngIf="tenantForm.get('correo_intercambio')?.hasError('email')">
            Formato de email inválido
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Configuración del Sistema (solo en edición) -->
    <div class="mb-6" *ngIf="data.isEdit && settingsForm">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Configuración del Sistema</h3>
      
      <div [formGroup]="settingsForm">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Nombre del Sistema</mat-label>
          <input matInput formControlName="name" placeholder="Nombre del sistema">
          <mat-icon matPrefix>label</mat-icon>
          <mat-error *ngIf="tenantForm.get('settings.name')?.hasError('required')">
            El nombre del sistema es requerido
          </mat-error>
        </mat-form-field>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Capacidad Máxima</mat-label>
            <input matInput type="number" formControlName="max_capacity" placeholder="0" min="0">
            <mat-icon matPrefix>directions_car</mat-icon>
            <mat-hint>Número máximo de vehículos que puede albergar el estacionamiento</mat-hint>
            <mat-error *ngIf="tenantForm.get('settings.max_capacity')?.hasError('min')">
              La capacidad debe ser mayor o igual a 0
            </mat-error>
          </mat-form-field>

          <div class="flex items-center mt-6">
            <mat-checkbox formControlName="pos_tuu">
              <span class="ml-2">POS TUU Habilitado</span>
            </mat-checkbox>
            <mat-icon class="ml-2 text-gray-500" [matTooltip]="'Habilita la integración con POS TUU'">info</mat-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Información del Usuario Principal (solo en creación) -->
    <div class="mb-6" *ngIf="!data.isEdit">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Usuario Principal</h3>
      
      <div [formGroup]="userForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Nombre del Usuario</mat-label>
            <input matInput formControlName="name" placeholder="Nombre completo">
            <mat-icon matPrefix>person</mat-icon>
            <mat-error *ngIf="tenantForm.get('user.name')?.hasError('required')">
              El nombre es requerido
            </mat-error>
            <mat-error *ngIf="tenantForm.get('user.name')?.hasError('minlength')">
              Debe tener al menos 2 caracteres
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" placeholder="usuario@ejemplo.com">
            <mat-icon matPrefix>email</mat-icon>
            <mat-error *ngIf="tenantForm.get('user.email')?.hasError('required')">
              El email es requerido
            </mat-error>
            <mat-error *ngIf="tenantForm.get('user.email')?.hasError('email')">
              Formato de email inválido
            </mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Contraseña</mat-label>
          <input matInput type="password" formControlName="password" placeholder="Mínimo 6 caracteres">
          <mat-icon matPrefix>lock</mat-icon>
          <mat-error *ngIf="tenantForm.get('user.password')?.hasError('required')">
            La contraseña es requerida
          </mat-error>
          <mat-error *ngIf="tenantForm.get('user.password')?.hasError('minlength')">
            La contraseña debe tener al menos 6 caracteres
          </mat-error>
        </mat-form-field>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="p-4">
  <button mat-button (click)="onCancel()" [disabled]="loading">
    Cancelar
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()" 
    [disabled]="loading || tenantForm.invalid">
    <mat-spinner *ngIf="loading" diameter="20" class="inline-block mr-2"></mat-spinner>
    <span *ngIf="!loading">{{ data.isEdit ? 'Actualizar' : 'Crear' }}</span>
    <span *ngIf="loading">Creando...</span>
  </button>
</mat-dialog-actions>

